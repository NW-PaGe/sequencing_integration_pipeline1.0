<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.5.22">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

    <meta name="author" content="DSSU/DIQA">
    <meta name="dcterms.date" content="2024-03-26">

    <title>Template Submitters Script</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "../index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="../site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
     <script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>  
      </head>

  <body class="quarto-notebook">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Template Submitters Script</h6>

            <a href="../notebooks/template_submitters.Rmd" class="btn btn-primary quarto-download-embed" download="template_submitters.Rmd">Download Notebook</a>
          </div>

     <header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Template Submitters Script</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
        
        <div class="quarto-title-meta">

                <div>
            <div class="quarto-title-meta-heading">Author</div>
            <div class="quarto-title-meta-contents">
                        <p>DSSU/DIQA </p>
                      </div>
          </div>
                
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">March 26, 2024</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#developer-notes" id="toc-developer-notes" class="nav-link" data-scroll-target="#developer-notes">Developer notes</a></li>
  </ul></li>
  <li><a href="#script-setup" id="toc-script-setup" class="nav-link" data-scroll-target="#script-setup">Script setup</a>
  <ul class="collapse">
  <li><a href="#libraries" id="toc-libraries" class="nav-link" data-scroll-target="#libraries">Libraries</a></li>
  </ul></li>
  <li><a href="#import-objects" id="toc-import-objects" class="nav-link" data-scroll-target="#import-objects">Import objects</a>
  <ul class="collapse">
  <li><a href="#data-objects" id="toc-data-objects" class="nav-link" data-scroll-target="#data-objects">Data objects</a></li>
  </ul></li>
  <li><a href="#access-wdrs" id="toc-access-wdrs" class="nav-link" data-scroll-target="#access-wdrs">Access WDRS</a>
  <ul class="collapse">
  <li><a href="#connect" id="toc-connect" class="nav-link" data-scroll-target="#connect">Connect</a></li>
  <li><a href="#query-wdrs" id="toc-query-wdrs" class="nav-link" data-scroll-target="#query-wdrs">Query WDRS</a></li>
  <li><a href="#create-matching-variables" id="toc-create-matching-variables" class="nav-link" data-scroll-target="#create-matching-variables">Create matching variables</a></li>
  </ul></li>
  <li><a href="#ingest-files" id="toc-ingest-files" class="nav-link" data-scroll-target="#ingest-files">Ingest files</a>
  <ul class="collapse">
  <li><a href="#compile-submissions" id="toc-compile-submissions" class="nav-link" data-scroll-target="#compile-submissions">Compile submissions</a></li>
  <li><a href="#remove-empty-files" id="toc-remove-empty-files" class="nav-link" data-scroll-target="#remove-empty-files">Remove empty files</a></li>
  <li><a href="#remove-invalid-files" id="toc-remove-invalid-files" class="nav-link" data-scroll-target="#remove-invalid-files">Remove invalid files</a>
  <ul class="collapse">
  <li><a href="#define-valid-submission-criteria" id="toc-define-valid-submission-criteria" class="nav-link" data-scroll-target="#define-valid-submission-criteria">Define valid submission criteria</a></li>
  <li><a href="#prepare-for-validation-checks" id="toc-prepare-for-validation-checks" class="nav-link" data-scroll-target="#prepare-for-validation-checks">Prepare for validation checks</a></li>
  <li><a href="#separate-valid-and-invalid-submissions" id="toc-separate-valid-and-invalid-submissions" class="nav-link" data-scroll-target="#separate-valid-and-invalid-submissions">Separate valid and invalid submissions</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#match-records" id="toc-match-records" class="nav-link" data-scroll-target="#match-records">Match records</a>
  <ul class="collapse">
  <li><a href="#prepare-for-matching" id="toc-prepare-for-matching" class="nav-link" data-scroll-target="#prepare-for-matching">Prepare for matching</a></li>
  <li><a href="#perform-matching" id="toc-perform-matching" class="nav-link" data-scroll-target="#perform-matching">Perform matching</a></li>
  </ul></li>
  <li><a href="#extract-records-for-fuzzy-matching" id="toc-extract-records-for-fuzzy-matching" class="nav-link" data-scroll-target="#extract-records-for-fuzzy-matching">Extract records for fuzzy matching</a></li>
  <li><a href="#prepare-roster" id="toc-prepare-roster" class="nav-link" data-scroll-target="#prepare-roster">Prepare roster</a>
  <ul class="collapse">
  <li><a href="#format-roster" id="toc-format-roster" class="nav-link" data-scroll-target="#format-roster">Format roster</a></li>
  <li><a href="#extract-records-for-keep_na" id="toc-extract-records-for-keep_na" class="nav-link" data-scroll-target="#extract-records-for-keep_na">Extract records for keep_na</a></li>
  <li><a href="#perform-quality-checks" id="toc-perform-quality-checks" class="nav-link" data-scroll-target="#perform-quality-checks">Perform quality checks</a></li>
  <li><a href="#create-final-roster" id="toc-create-final-roster" class="nav-link" data-scroll-target="#create-final-roster">Create final roster</a></li>
  <li><a href="#extract-records-for-manual-review" id="toc-extract-records-for-manual-review" class="nav-link" data-scroll-target="#extract-records-for-manual-review">Extract records for manual review</a></li>
  </ul></li>
  <li><a href="#generate-output" id="toc-generate-output" class="nav-link" data-scroll-target="#generate-output">Generate output</a></li>
  <li><a href="#email-receipt" id="toc-email-receipt" class="nav-link" data-scroll-target="#email-receipt">Email receipt</a></li>
  <li><a href="#move-processed-files" id="toc-move-processed-files" class="nav-link" data-scroll-target="#move-processed-files">Move processed files</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">      

       <div class="cell-container"><div class="cell-decorator"><pre>In [1]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<section id="overview" class="level1 tabset">
<h1 class="tabset">Overview</h1>
<p><strong>Current Run Schedule:</strong> M, W, F @ 11:00AM<br>
<em>This script must run prior to fuzzy matching and roster compile scripts on roster days.</em></p>
<p>Sometimes adhoc submissions are added the morning of a roster, so run time should allow some opportunity for external parties to drop new files to be included in the day’s roster.</p>
<p><em>Where do the input files come from?</em> This script receives patient-level sequencing information submitted by laboratories in a standard template format as .csv or .xlsx files.</p>
<p><em>What happens during the script?</em> The patient-level information contained in the submission files is joined to COVID-19 genomic sequencing results in the WDRS ELR Entire table. Records are matched on accession number (exact match) and specimen collection date (within a margin of 14 days). Then, entries undergo cleaning, variables of interest are generated, QA checks are performed, and the results are transformed into the sequencing roster format.</p>
<p><em>What is output from this script?</em></p>
<ul>
<li><p>fuzzy_match: Records that contain demographic information but cannot be matched using clinical accession number are sent to the FUZZY_MATCHING script</p></li>
<li><p>write_roster_here: Valid matched records are compiled and output to the write_roster_here folder for inclusion in the sequencing roster</p></li>
<li><p>For_Review/to_process: Invalid submissions that do not have a sequence status or FAILED or LOW QUALITY are sent to For_Review/to_process folder in the manual review format</p></li>
<li><p>keep_na: Records that meet the criteria for the keep_na process are appended to the existing data object to be reconsidered for matching at a later date</p></li>
<li><p>Completed_Submissions/Template_Submitters/last_run.csv: This is a reference list used internally by this script (i.e.&nbsp;not output to external sources) to document which files were processed in the prior run. Sometimes the final chunk of code fails to delete submission files that are open in the R session. This list is updated at the end of a code run and indicates which files were processed. When the script scans the Submissions folder for new files at the beginning of a code run, it uses this reference list to complete the process of removing those files if any are lingering. Using this approach, no manual action is required to move files.</p></li>
</ul>
<p>At the end of the script, the processed files are moved from their locations within the Submissions folder to the Completed Submissions folder. An email receipt is also generated at this time.</p>
<p><em>Note: This process is not an ideal method for receiving records. Ultimately we hope to transition all submitters to electronic laboratory reporting (ELR), which is preferable to receiving piecemeal .csv documents. However, using a template does improve consistency among submitters that have not adopted ELR, which allows us to prepare their records for rostering in a somewhat standardized manner. The incoming .csv files can be subject to formatting or submitter error and sometimes require manual edits before the script can properly ingest them.</em></p>
<section id="developer-notes" class="level2">
<h2 class="anchored" data-anchor-id="developer-notes">Developer notes</h2>
<p>In order to process files from a new submitter, a few actions need to be taken to update this script:</p>
<ol type="1">
<li><p>If a new sender is validated to submit patient-level sequencing information following the template format, <em>the laboratory name needs to be added to the lab_vars object via the</em> <strong>write_lab_vars_here.R</strong> <em>script</em>. There is a code chunk listing all confirmed template submitters (lab_names_template), and the spelling must match that of the SUBMITTING_LAB column in the submission; simply add the new name to the list! Other scripts beyond this one use that shared object to access the acceptable values for a given field, so making a change in the lab_vars object will populate downstream.</p></li>
<li><p>If the new sender very rarely submits information, it may be appropriate to drop their new files into the Submissions/adhoc subfolder. If they are regularly sending sequencing data via SFT, a designated sub-folder should be created for that submitter in the Submissions folder. <em>Make sure code</em> <strong>Chunk 10</strong> <em>of this script includes all of the Submissions sub-folders that contribute Template Submissions for ingestion into this script.</em> (Upon completion of the script, files are moved from their Submissions sub-folder to a corresponding Completed Submissions sub-folder – this could be created at the same time, but won’t be used until later!)</p></li>
<li><p>Then, examine the format of the GISAID_IDs included in submissions from the new laboratory to determine what modifications should be made to the validation steps in <strong>Chunk 14</strong>. If the GISAID_IDs follow the standard “^(hCoV-19/)?USA/WA-.*/[[:digit:]]{4}$” regex pattern, update the list of other submitters to include any new Submissions sub-folders created in the previous step. If the GISAID_IDs do not follow the expected pattern (likely due to a text prefix or unusual number of characters), a new set of code must be written to indicate the typical GISAID_ID format for that submitter for future validation – this has already been done for Aegis, Helix, and Labcorp, so there is an example to follow! In a related step, <strong>Chunk 17</strong> must be updated to standardize GISAID_IDs for the new submitter if they are partial or do not follow the usual regex pattern.</p></li>
<li><p>Next, updates need to be made to <strong>Chunk 20</strong> where columns for the final sequencing roster are created. The SEQUENCE_LAB variable is derived from the SUBMITTING_LAB variable included in the submissions. <em>The variable should be updated to mutate this variable properly for the new submitter.</em> Note that submitters sometimes use different values in the SEQUENCE_LAB column (they’re not supposed to, but it happens), but only one value per submitter should be output. This is in part addressed by the code in Chunk 20 using str_detect to identify the lab – real-life example: str_detect(toupper(SUBMITTING_LAB), “UW VIROLOGY”) ~ “UW Virology” will catch submissions that have been sent with a SUBMITTING_LAB of “UW Virology” or “UW Virology Lab”. Similarly, str_detect(toupper(SUBMITTING_LAB), “AEGIS”) ~ “Aegis” detects submissions from “Aegis” or “Aegis Sciences Corporation”. However, multiple rows may need to be written per submitter if they use acronyms or other names that do not contain shared text – example: the United States Air Force has sent submissions with the name “USAFSA” and “United States Air Force School of Aerospace” in the SUBMITTING_LAB column; two lines of code are needed for each variant of the name, but both output the same value to roster: “USAFSA”.</p></li>
<li><p>After the script has run, files need to be moved from their sub-folders within the Submissions folder to Completed Submissions. <strong>Chunk 30</strong> contains code to move these files. <em>The name of any new sub-folders in Submissions and Completed Submissions need to be included here.</em></p></li>
</ol>
<p>These steps may not be comprehensive, and files from new submitters may contain their own idiosyncrasies - but this should offer a decent starting place if adding a newly validated laboratory to our suite of template submitters!</p>
</section>
</section>
<section id="script-setup" class="level1 tabset">
<h1 class="tabset">Script setup</h1>
<section id="libraries" class="level2">
<h2 class="anchored" data-anchor-id="libraries">Libraries</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [2]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(odbc)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fs)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vroom)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="import-objects" class="level1 tabset">
<h1 class="tabset">Import objects</h1>
<section id="data-objects" class="level2">
<h2 class="anchored" data-anchor-id="data-objects">Data objects</h2>
<p>This part of the script calls several data objects that contain information required for this process. The lab_vars object is curated by Sequencing Project script runners and serves as a master reference for validated variable input. Adding new submitters, sequencing reasons, etc should be done in this object so the changes populate across all scripts that use these variables.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [3]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in r_creds.RDS</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>r_creds <span class="ot">&lt;-</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="fu">Sys.getenv</span>(<span class="st">"USERPROFILE"</span>), <span class="st">"Projects/Sequencing/Data_Objects"</span>, <span class="st">"r_creds.RDS"</span>)) </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in keep_na</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>keep_na_running <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"keep_na/keep_na.csv"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>)) </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in lineages</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>lineages <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data_Objects/Lineages/Lineages.csv"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_names =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>)) </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the Washington_cumulative file (contains records submitted by CDC contracted labs)</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>wa_cdc <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Submissions/CDC_Cumulative/Washington_cumulative.csv"</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>)) </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in lab_vars</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>lab_vars <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Data_Objects/lab_variables.rds"</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in quality_filters</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(<span class="fu">Sys.getenv</span>(<span class="st">"USERPROFILE"</span>), <span class="st">"Projects/Sequencing/Roster_scripts/quality_filters.R"</span>))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove submissions that were duplicated in Completed Submissions at the end of the last run</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>last_run <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Completed_Submissions/Template_Submitters/Template_Submitters_File_Completed.csv"</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(last_run)) {</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="fu">paste0</span>(last_run[i,<span class="dv">1</span>]))) { </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">paste0</span>(last_run[i,<span class="dv">1</span>]))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="access-wdrs" class="level1 tabset">
<h1 class="tabset">Access WDRS</h1>
<section id="connect" class="level2">
<h2 class="anchored" data-anchor-id="connect">Connect</h2>
<p>Establish a connection to WDRS using credentials stored in a data object.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [4]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># connect</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(), </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Driver =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">1</span>], </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Server =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">2</span>], </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Database =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">3</span>], </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Trusted_connection =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">4</span>], </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ApplicationIntent =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="query-wdrs" class="level2">
<h2 class="anchored" data-anchor-id="query-wdrs">Query WDRS</h2>
<p>After connecting to the WDRS database, create ENTIRE and FLATTENED tables in R global environment</p>
<ul>
<li><strong>ENTIRE</strong> table contains all WDRS SARS-CoV-2 entries</li>
<li><strong>FLATTENED</strong> table contains WDRS SARS-CoV-2 entries that have been included in the sequencing roster</li>
</ul>
<div class="cell-container"><div class="cell-decorator"><pre>In [5]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WDRS ENTIRE TABLE</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Pull CASE_ID, SEQUENCE_CLINICAL_ACCESSION AND COLLECTION_DATE FROM the [DD_ELR_DD_ENTIRE] table on WDRS</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="do">## This table will be joined against to pull CASE_ID's using the SEQUENCE_CLINICAL_ACCESSION</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>wdrs_ent <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(connection, <span class="st">"</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="st">                    SELECT Distinct CASE_ID,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="st">                      [FILLER__ORDER__NUM] as FILLER__ORDER__NUM__WDRS,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="st">                      SPECIMEN__COLLECTION__DTTM as SPECIMEN__COLLECTION__DTTM__WDRS</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="st">                    FROM [dbo].[DD_ELR_DD_ENTIRE]</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="st">                    WHERE CODE = 'SARS' AND STATUS != '6' </span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="st">                    "</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform COLLECTION_DATE to character format</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>wdrs_ent<span class="sc">$</span>SPECIMEN__COLLECTION__DTTM__WDRS <span class="ot">&lt;-</span> <span class="fu">as.character</span>(wdrs_ent<span class="sc">$</span>SPECIMEN__COLLECTION__DTTM__WDRS) </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># WDRS FLATTENED TABLE</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Pull all SEQUENCE_ACCESSION from the [DD_GCD_COVID_19_FLATTENED] table on WDRS. (these are specimens that have already been rostered)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="do">## The final roster will be filtered against this table to remove any potential duplicates</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>wdrs_flat <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(connection, <span class="st">"</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="st">                    SELECT DISTINCT CDC_N_COV_2019_SEQUENCE_ACCESSION_NUMBER,</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="st">                    CDC_N_COV_2019_SEQUENCE_CLINICAL_ACCESSION_NUMBER</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="st">                    FROM [dbo].[DD_GCD_COVID_19_FLATTENED]</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="st">                    "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="create-matching-variables" class="level2">
<h2 class="anchored" data-anchor-id="create-matching-variables">Create matching variables</h2>
<p>SEQUENCE_ACCESSION and SEQUENCE_CLINICAL_ACCESSION values are extracted from WDRS. These unique identifiers will be used to match genomic sequencing records to the incoming submissions with patient-level information.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [6]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector containing individual SEQUENCE_ACCESSIONS</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This variable is located in the first column of the WDRS FLATTENED table </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract comma separated values if fields have multiple SEQUENCE_ACCESSIONS</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>wdrs_sa_flat_split <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">str_split</span>(wdrs_flat[[<span class="dv">1</span>]], <span class="st">","</span>))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Omit any NAs</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>wdrs_sa_flat_clean <span class="ot">&lt;-</span> wdrs_sa_flat_split[<span class="sc">!</span><span class="fu">is.na</span>(wdrs_sa_flat_split)] <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Remove "hCoV-19/" from the beginning of SEQUENCE_ACCESSION if it has been appended (replace with "")</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_replace</span>(<span class="st">"hCoV-19/"</span>, <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Trim white space resulting from str_split and remove " " values  </span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_trim</span>(<span class="st">"both"</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Remove any values equal to ""</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>wdrs_sa_flat_values <span class="ot">&lt;-</span> wdrs_sa_flat_clean[wdrs_sa_flat_clean <span class="sc">!=</span> <span class="st">""</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [7]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector containing individual SEQUENCE_CLINICAL_ACCESSIONS</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This variable is located in the second column of the WDRS FLATTENED table</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Extract comma separated values if fields have multiple SEQUENCE_CLINICAL_ACCESSIONS</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>wdrs_sca_flat_split <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">str_split</span>(wdrs_flat[[<span class="dv">2</span>]], <span class="st">","</span>))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Omit any NAs</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>wdrs_sca_flat_clean <span class="ot">&lt;-</span> wdrs_sca_flat_split[<span class="sc">!</span><span class="fu">is.na</span>(wdrs_sca_flat_split)] <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Trim white space resulting from str_split and remove " " values  </span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_trim</span>(<span class="st">"both"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Remove any values equal to ""</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>wdrs_sca_flat_values <span class="ot">&lt;-</span> wdrs_sca_flat_clean[wdrs_sca_flat_clean <span class="sc">!=</span> <span class="st">""</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="ingest-files" class="level1 tabset">
<h1 class="tabset">Ingest files</h1>
<section id="compile-submissions" class="level2">
<h2 class="anchored" data-anchor-id="compile-submissions">Compile submissions</h2>
<p>New laboratory submissions are dropped in their corresponding sub-folders in the Submissions folder.</p>
<p>This code chunk examines all Submissions sub-folders that have been validated to accept Template Submissions and compiles a list of paths to all files present in these folders.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [8]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify paths to folders containing Template Submissions</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>submissions <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(<span class="fu">c</span>(<span class="st">"Submissions/Adhoc"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Aegis"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Altius"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/ASU"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Boise_VA"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Fulgent_Genetics"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Gravity Diagnostics"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Helix"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Infinity_Biologix"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Kaiser"</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Labcorp"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Lauring_Lab"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/NW_Genomics"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/Quest"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/UnitedStatesAirForceSchoolofAerospace"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Submissions/UW_Virology"</span>),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">recurse =</span> <span class="cn">TRUE</span>, <span class="at">type =</span> <span class="st">"file"</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                          )</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of metadata for the new submission dataframes</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> submissions <span class="sc">%&gt;%</span> </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map_if</span>(<span class="fu">str_sub</span>(., <span class="sc">-</span><span class="dv">4</span>, <span class="sc">-</span><span class="dv">1</span>) <span class="sc">==</span> <span class="st">"xlsx"</span>, </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>         <span class="cf">function</span>(x) <span class="fu">read_xlsx</span>(x, <span class="at">col_types =</span> <span class="st">"text"</span>, <span class="at">na =</span> <span class="fu">c</span>(<span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">""</span>, <span class="st">"None"</span>, <span class="st">"none"</span>)),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">.else =</span>  <span class="cf">function</span>(x) <span class="fu">vroom</span>(x, <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>), <span class="at">na =</span> <span class="fu">c</span>(<span class="st">"NA"</span>, <span class="st">"N/A"</span>, <span class="st">""</span>, <span class="st">"None"</span>, <span class="st">"none"</span>))</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a backup of the submitted files in their original state</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>files_original <span class="ot">&lt;-</span> files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="remove-empty-files" class="level2">
<h2 class="anchored" data-anchor-id="remove-empty-files">Remove empty files</h2>
<p>This code chunk examines the new submissions and identifies any empty files for removal</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [9]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm that a non-zero number of submissions were received</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm that the files received contain data, not just an empty template</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Occasionally, a submitter may send a file with empty rows or missing observations aside from SUBMITTING_LAB</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Files without any complete observations are errors by the submitter part and should be removed</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For every df in files</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter to rows where the sum of fields not missing data across all columns (1:12) is greater than 1</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    files[[i]] <span class="ot">&lt;-</span> <span class="fu">filter</span>(files[[i]], <span class="fu">rowSums</span>(<span class="sc">!</span><span class="fu">is.na</span>(files[[i]][, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(files[[i]])])) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty vector to hold the filepaths of submissions that do not contain any data (empty)</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>empty_submissions <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># For every df in files</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) {</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If there are 0 rows of data (file is empty)</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append the filepath to the empty_submissions</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    empty_submissions <span class="ot">&lt;-</span> <span class="fu">c</span>(empty_submissions, <span class="fu">names</span>(files[i]))</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any empty submissions from the files object</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(empty_submissions) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> files[<span class="fu">names</span>(files) <span class="sc">!=</span> empty_submissions]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Send an email and stop here if there are no files or records to process</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [10]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare email details and message</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Note that the files object had empty files removed in the previous chunk -- therefore, it will have a length equal to 0 if there were no files received OR if there were no populated files received</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  email_from <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  email_to <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  email_subj <span class="ot">&lt;-</span> <span class="st">"SEQUENCING - Template Submitters"</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="do">## If there are no new files</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(files_original) <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  email_body_no_files <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"There are no new template submitter files to process on "</span>, <span class="fu">today</span>()),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  email_body_no_files <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">""</span>))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="do">## If there are only empty files</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(files_original) <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  email_body_only_empty <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"All of the template submitter files received on "</span>, <span class="fu">today</span>(), <span class="st">" were empty (i.e. contained no records): </span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">print</span>(empty_submissions), </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"</span><span class="sc">\n\n</span><span class="st"> No records will be processed by the template submitters script today."</span>),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  email_body_only_empty <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">""</span>))</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="do">## Compose message</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>email_body <span class="ot">&lt;-</span> <span class="fu">paste0</span>(email_body_no_files, <span class="st">"</span><span class="sc">\r</span><span class="st">"</span>, email_body_only_empty)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Send email</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>sendmailR<span class="sc">::</span><span class="fu">sendmail</span>(<span class="at">from =</span> email_from,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                    <span class="at">to =</span> email_to,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                    <span class="at">subject =</span> email_subj,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                    <span class="at">msg =</span> email_body,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>                    <span class="at">headers=</span> <span class="fu">list</span>(<span class="st">"Reply-To"</span> <span class="ot">=</span> email_from),</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">smtpServer =</span> <span class="st">""</span>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="fu">stop</span>(<span class="st">"Stop script here."</span>, </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>     <span class="st">"</span><span class="sc">\n</span><span class="st"> A total of "</span>, <span class="fu">length</span>(files_original), <span class="st">" files were received today. </span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>     <span class="fu">length</span>(empty_submissions), <span class="st">" files were empty (i.e. contained no records)."</span>, </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>     <span class="st">"</span><span class="sc">\n</span><span class="st"> An email receipt has been sent."</span>)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co"># If there are empty files submitted alongside populated files, the script can proceed. However, we want to inform stakeholders of the empty files so they can be addressed. This message will be appended to any future emails generated by this script</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(empty_submissions) <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  email_body_empty_files <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">length</span>(empty_submissions), <span class="st">" file(s) received today was/were empty (i.e. contained no records) and may require manual follow up: </span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">print</span>(empty_submissions)),</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  email_body_empty_files <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">""</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>All files processed beyond this point will contain a non-zero number of observations.</p>
</section>
<section id="remove-invalid-files" class="level2 tabset">
<h2 class="tabset anchored" data-anchor-id="remove-invalid-files">Remove invalid files</h2>
<p>This section of code examines the new submissions and identifies any files that do not follow the template provided to laboratories for submitting records. Files that do not contain the variables specified below, with identical column names and orders, may not meet the criteria for ingestion and could encounter errors with subsequent steps in this script to prepare them for rostering. These files likely need manual review and may require corrections by the script runner or laboratory submitter.</p>
<section id="define-valid-submission-criteria" class="level3">
<h3 class="anchored" data-anchor-id="define-valid-submission-criteria">Define valid submission criteria</h3>
<p>The following chunk establishes the parameters expected of submission files following the template. The incoming files will be compared against these criteria to determine whether they can be processed by the remainder of the script as-is.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [11]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector containing the template submission variable names in the correct order</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>template_col_names <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LAB_ACCESSION_ID"</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GISAID_ID"</span>, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SPECIMEN_COLLECTION_DATE"</span>, </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SUBMITTING_LAB"</span>, </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SEQUENCE_REASON"</span>, </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SEQUENCE_STATUS"</span>, </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PANGO_LINEAGE"</span>, </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"FIRST_NAME"</span>, </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LAST_NAME"</span>, </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MIDDLE_NAME"</span>, </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DOB"</span>, </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ALTERNATIVE_ID"</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector naming validated template submitters (SUBMITTING_LAB)</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>submitting_lab_values <span class="ot">&lt;-</span> lab_vars<span class="sc">$</span>lab_names_template</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector containing valid values for SEQUENCE_REASON</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note that NA and blanks are accepted</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>sequence_reason_values <span class="ot">&lt;-</span> lab_vars<span class="sc">$</span>seq_reason_template</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a vector containing valid values for SEQUENCE_STATUS</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note that NA and blanks are not accepted</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>sequence_status_values <span class="ot">&lt;-</span> lab_vars<span class="sc">$</span>seq_status_template</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract a list of valid lineages from the lineages_list object (this should be updated daily via an automated script)</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Append "" and NA, as records with a LOW QUALITY or FAILED sequence status will not contain lineage information</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>lineages_list <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  lineages[[<span class="dv">1</span>]], </span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">""</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"UNASSIGNED"</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Unassigned"</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Many of the valid values are located within the lab_vars data object – this is meant to serve as a centralized source of validated information across multiple scripts, so updates to these variables only need to be made once. To add, remove, or otherwise edit relevant variables, make changes to the Roster_scripts//write_lab_variables.R script and update the data object that is output.</p>
</section>
<section id="prepare-for-validation-checks" class="level3">
<h3 class="anchored" data-anchor-id="prepare-for-validation-checks">Prepare for validation checks</h3>
<p>Invalid files will be identified as those having formats or columns that do not match the template criteria outlined in the previous chunk.</p>
<p>The following 8 items are checked for errors:</p>
<ul>
<li><em>format</em> - variable names and order are correct</li>
<li><em>gisaid</em> - GISAID_ID variable is the expected format (varies by submitter) <em>and</em> there are no GISAID_IDs assigned to records with a SEQUENCE_STATUS that is not COMPLETE</li>
<li><em>lab</em> - SUBMITTING_LAB values are valid</li>
<li><em>reason</em> - SEQUENCE_REASON values are valid</li>
<li><em>status</em> - SEQUENCE_STATUS values are valid</li>
<li><em>collection date</em> - SPECIMEN_COLLECTION_DATE is in a valid format</li>
<li><em>lineage</em> - PANGO_LINEAGE values are valid</li>
</ul>
<p>Invalid files cannot be processed until all errors identified in this quality check are corrected.</p>
<p>The next code chunk creates a dataframe to locate which errors are present in each submission file.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [12]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a dataframe to identify work-stop errors within files</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>invalid_submission_reason <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="fu">length</span>(files),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">8</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(), <span class="fu">c</span>(</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"submission"</span>, <span class="co"># identify the submission filepath</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format_check"</span>, </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gisaid_check"</span>, </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lab_check"</span>, </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reason_check"</span>, </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"status_check"</span>, </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"coll_date_check"</span>, </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lineage_check"</span>))</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign each file to a row in the df</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>invalid_submission_reason[,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">names</span>(files)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># FORMAT CHECK</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="do">## For every submission in files, check that the formatting of the dataframe has not been altered; if so, populate error message in invalid_submissions_reason</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Sometimes there appears to be additional columns - can use this to remove them. Replace with number of file. files[[7]] &lt;- files[[7]][1:12]</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) { </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">all</span>(<span class="fu">names</span>(files[[i]]) <span class="sc">==</span> template_col_names))) {</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    invalid_submission_reason[i, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid submission format - file variables do not match template"</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co"># GISAID_ID CHECK</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="do">## GISAID_ID formats vary by submitter. for every submission in files, check that the GISAID_ID values are in the typical format for each submitter and there are not GISAID_ID values present for samples with a sequence status that is not COMPLETE</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Note: Aegis, Helix, Labcorp, and Quest are currently submitting via ELR (per 03.11.2022); Because ad-hoc corrections or other records from these labs are sometimes manually dropped into Submissions, we have retained the code to process these records</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) {</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aegis</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">str_detect</span>(<span class="fu">names</span>(files[i]), <span class="st">"Submissions/Aegis"</span>)) {</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(files[[i]])) {</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>((<span class="sc">!</span>(</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"^ASC([[:digit:]])*-B.*"</span>))<span class="sc">|</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"LOW QUALITY"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"^ASC([[:digit:]])*-B.*"</span>))<span class="sc">|</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">!=</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID))</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>      )))) {</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        invalid_submission_reason[i, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid GISAID_IDs - check for unexpected format by submitter or GISAID_IDss assigned to records where SEQUENCE_STATUS is not COMPLETE"</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helix</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(<span class="fu">names</span>(files[i]), <span class="st">"Submissions/Helix"</span>)) {</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(files[[i]])) {</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>((<span class="sc">!</span>(</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"USA/WA-CDC-STM-.*"</span>))<span class="sc">|</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"LOW QUALITY"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"USA/WA-CDC-STM-.*"</span>))<span class="sc">|</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">!=</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID))</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>      )))) {</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>        invalid_submission_reason[i, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid GISAID_IDs - check for unexpected format by submitter or GISAID_IDss assigned to records where SEQUENCE_STATUS is not COMPLETE"</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Labcorp</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(<span class="fu">names</span>(files[i]), <span class="st">"Submissions/Labcorp"</span>)) {</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(files[[i]])) {</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">any</span>((<span class="sc">!</span>(</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"^LC[[:digit:]]*$"</span>))<span class="sc">|</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"LOW QUALITY"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"^LC[[:digit:]]*$"</span>))<span class="sc">|</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">!=</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID))</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>      )))) {</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        invalid_submission_reason[i, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid GISAID_IDs - check for unexpected format by submitter or GISAID_IDss assigned to records where SEQUENCE_STATUS is not COMPLETE"</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Other submitters</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(<span class="fu">names</span>(files[i]), <span class="st">"Submissions/(</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="st">                      Adhoc|</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="st">                      Altius|</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a><span class="st">                      ASU|</span></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a><span class="st">                      Boise_VA|</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a><span class="st">                      Fulgent_Genetics|</span></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span class="st">                      Gravity Diagnostics|</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a><span class="st">                      Infinity_Biologix|</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a><span class="st">                      Kaiser|</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a><span class="st">                      Lauring_Lab|</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="st">                      NW_Genomics|</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a><span class="st">                      Quest|</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a><span class="st">                      UnitedStatesAirForceSchoolofAerospace|</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a><span class="st">                      UW_Virology</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a><span class="st">                      )"</span>)) {</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(files[[i]])) {</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>((<span class="sc">!</span>(</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"^(hCoV-19/)?USA/WA-.*/[[:digit:]]{4}$"</span>))<span class="sc">|</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">==</span> <span class="st">"LOW QUALITY"</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID, <span class="st">"^(hCoV-19/)?USA/WA-.*/[[:digit:]]{4}$"</span>))<span class="sc">|</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>        (<span class="fu">toupper</span>(files[[i]][j,]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">!=</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(files[[i]][j,]<span class="sc">$</span>GISAID_ID))</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>      )))) {</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>        invalid_submission_reason[i, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid GISAID_IDs - check for unexpected format by submitter or GISAID_IDss assigned to records where SEQUENCE_STATUS is not COMPLETE"</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a><span class="co"># LAB CHECK</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="do">## For every submission in files, check that the submitting lab variable contains valid values; if not, populate error message in invalid_submissions_reason</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Note: Sometimes labs will switch the name they submit under without warning -- examples: "UW Virology Lab" -&gt; "UW Virology", "Aegis" -&gt; "Aegis Sciences Corporation". When a submitter makes a consistent change like this, the write_lab_vars.R script has typically been updated to accept both phrasings</span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) { </span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">all</span>(files[[i]]<span class="sc">$</span>SUBMITTING_LAB <span class="sc">%in%</span> submitting_lab_values))) {</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>    invalid_submission_reason[i, <span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid values in SUBMITTING_LAB variable"</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a><span class="co"># REASON CHECK</span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a><span class="do">## For every submission in files, check that the sequence reason variable contains valid values; if not, populate error message in invalid_submissions_reason</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) { </span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">all</span>(<span class="fu">toupper</span>(files[[i]]<span class="sc">$</span>SEQUENCE_REASON) <span class="sc">%in%</span> sequence_reason_values))) {</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>    invalid_submission_reason[i, <span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid values in SEQUENCE_REASON variable"</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a><span class="co"># STATUS CHECK</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a><span class="do">## For every submission in files, check that the sequence status variable contains valid values; if not, populate error message in invalid_submissions_reason</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) { </span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">all</span>(<span class="fu">toupper</span>(files[[i]]<span class="sc">$</span>SEQUENCE_STATUS) <span class="sc">%in%</span> sequence_status_values))) {</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>    invalid_submission_reason[i, <span class="dv">6</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid values in SEQUENCING_STATUS variable"</span></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a><span class="co"># COLLECTION DATE CHECK</span></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a><span class="do">## For every submission in files, check that the specimen collection date is in a valid format; if not, populate error message in invalid_submissions_reason</span></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) { </span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">all</span>(<span class="sc">!</span>(<span class="fu">is.na</span>(files[[i]]<span class="sc">$</span>SPECIMEN_COLLECTION_DATE)) <span class="sc">&amp;</span> </span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_detect</span>(files[[i]]<span class="sc">$</span>SPECIMEN_COLLECTION_DATE,</span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"[[:digit:]]{1,2}[[:punct:]][[:digit:]]{1,2}[[:punct:]][[:digit:]]{4}|[[:digit:]]{4}[[:punct:]][[:digit:]]{1,2}[[:punct:]][[:digit:]]{1,2}|[[:digit:]]{5}"</span>)))) {</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>    invalid_submission_reason[i, <span class="dv">7</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid SPECIMEN_COLLECTION_DATE - check for incorrect date format"</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a><span class="co"># LINEAGE CHECK</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a><span class="do">## For every submission in files, check that the PANGO lineage variable contains valid values; if not, populate error message in invalid_submissions_reason</span></span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(files)) { </span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span>(<span class="fu">all</span>(<span class="fu">toupper</span>(files[[i]]<span class="sc">$</span>PANGO_LINEAGE) <span class="sc">%in%</span> lineages_list))) {</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>    invalid_submission_reason[i, <span class="dv">8</span>] <span class="ot">&lt;-</span> <span class="st">"Invalid values in PANGO_LINEAGE variable"</span></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="separate-valid-and-invalid-submissions" class="level3">
<h3 class="anchored" data-anchor-id="separate-valid-and-invalid-submissions">Separate valid and invalid submissions</h3>
<div class="cell-container"><div class="cell-decorator"><pre>In [13]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract invalid files (i.e. triggered QA check errors, do not meet the criteria to be processed)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>invalid_files_subset <span class="ot">&lt;-</span> invalid_submission_reason <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(<span class="fu">rowSums</span>(<span class="fu">is.na</span>(invalid_submission_reason[, <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>)])) <span class="sc">==</span> <span class="dv">6</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract valid files (i.e. no QA check errors, meet all criteria to be processed)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>valid_files_subset <span class="ot">&lt;-</span> invalid_submission_reason <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">rowSums</span>(<span class="fu">is.na</span>(invalid_submission_reason[, <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>)])) <span class="sc">==</span> <span class="dv">6</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind valid_files into a single dataframe</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>valid_files <span class="ot">&lt;-</span> files[<span class="fu">names</span>(files) <span class="sc">%in%</span> valid_files_subset[[<span class="dv">1</span>]]]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>files_bind <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(valid_files, <span class="at">.id =</span> <span class="st">"column_label"</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Built-in stop in case no valid files; Print summary</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Note: sometimes a batch of files from a single submitter containing identical errors will be received, and often it just requires a simple fix. It's preferable to stop here and address the error manually rather than send out a premature email stating that all files cannot be processed today</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If errors are corrected at this point, rerun from Chunk 13 (validation checks) to see if fixed! </span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">stop</span>(<span class="fu">paste0</span>(<span class="st">"NOTES FOR SCRIPT RUNNER:"</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"Stop script to review files."</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="fu">length</span>(files), <span class="st">" files were detected in the Submissions folders"</span>),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"   Valid files: "</span>, <span class="fu">nrow</span>(valid_files_subset),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="st">"   Invalid files: "</span>, <span class="fu">nrow</span>(invalid_files_subset),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="st">"Proceed with script or perform manual review as necessary."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Stop script and send email if all incoming files are invalid.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [14]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize vectors to hold messages</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>invalid_files_message <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>final_invalid_files_message <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># For all invalid files, note the filepath and the errors that were identified</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(invalid_files_subset)) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(invalid_files_subset)) {</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    invalid_files_message[i] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(invalid_files_subset[i,][<span class="sc">!</span><span class="fu">is.na</span>(invalid_files_subset[i,])], <span class="at">collapse=</span><span class="st">"</span><span class="sc">\n</span><span class="st">     - "</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Collapse invalid_files that have been processed by line</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  invalid_files_message <span class="ot">&lt;-</span>  <span class="fu">paste0</span>(invalid_files_message, <span class="at">collapse=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compose final message</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  final_invalid_files_message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"The following file(s) are invalid and have not been processed: "</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, invalid_files_message)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># If there are files to process but none are valid (i.e all files are invalid), send an email stating so</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ((<span class="fu">length</span>(files) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (<span class="fu">length</span>(valid_files) <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  email_from <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  email_to <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  email_subj <span class="ot">&lt;-</span> <span class="st">"SEQUENCING - Template Submitters"</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  email_body <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"There are submissions to process, however, the submission files are invalid and require correction. There are no valid submissions that can be processed "</span>, <span class="fu">today</span>(), <span class="st">"."</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, final_invalid_files_message,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, email_body_empty_files) <span class="co"># Append message regarding any empty files</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Send email</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>sendmailR<span class="sc">::</span><span class="fu">sendmail</span>(<span class="at">from =</span> email_from,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                    <span class="at">to =</span> email_to,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>                    <span class="at">subject =</span> email_subj,</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>                    <span class="at">msg =</span> email_body,</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>                    <span class="at">headers=</span> <span class="fu">list</span>(<span class="st">"Reply-To"</span> <span class="ot">=</span> email_from),</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">smtpServer =</span> <span class="st">""</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop the script if all incoming submissions are invalid </span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ((<span class="fu">length</span>(files) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (<span class="fu">length</span>(valid_files) <span class="sc">==</span> <span class="dv">0</span>)) {</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"All files are invalid. File(s) require correction. Script will stop here."</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
</section>
<section id="match-records" class="level1 tabset">
<h1 class="tabset">Match records</h1>
<section id="prepare-for-matching" class="level2">
<h2 class="anchored" data-anchor-id="prepare-for-matching">Prepare for matching</h2>
<p>The next code chunk performs data cleaning and mutation to prepare the valid patient-level records for matching to WDRS entries.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [15]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>records_mut <span class="ot">&lt;-</span> files_bind <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize format of SPECIMEN_COLLECTION_DATE as ymd</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SPECIMEN_COLLECTION_DATE =</span> <span class="fu">case_when</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse as ymd when SPECIMEN_COLLECTION_DATE is a 5 digit numeric string (Excel date)</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(SPECIMEN_COLLECTION_DATE, <span class="st">"^[[:digit:]]{5}$"</span>) <span class="sc">~</span> <span class="fu">as.character</span>(openxlsx<span class="sc">::</span><span class="fu">convertToDate</span>(SPECIMEN_COLLECTION_DATE)),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse as ymd when SPECIMEN_COLLECTION_DATE is not a 5 digit numeric string - in a mdy (template submission) or ymd (Fulgent) format</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">str_detect</span>(SPECIMEN_COLLECTION_DATE, <span class="st">"^[[:digit:]]{5}$"</span>) <span class="sc">~</span> <span class="fu">as.character</span>(<span class="fu">ymd</span>(<span class="fu">parse_date_time</span>(SPECIMEN_COLLECTION_DATE, <span class="fu">c</span>(<span class="st">"mdy"</span>, <span class="st">"ymd"</span>))))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform and standardize GISAID_ID by submitter</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Note: Aegis, Helix, Labcorp, and Quest are currently submitting via ELR (per 03.11.2022); Because ad-hoc corrections or other records from these labs are sometimes manually dropped into Submissions, we have retained the code to process these records</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GISAID_ID =</span> <span class="fu">case_when</span>(</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aegis submits a partial GISAID_ID with excess string at the end: remove '-BXXXXXX', append 'hCoV-19/' prefix, append '/[year of collection date]' suffix</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    SUBMITTING_LAB <span class="sc">==</span> <span class="st">"Aegis"</span> <span class="sc">&amp;</span> </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">replace_na</span>(<span class="fu">str_detect</span>(<span class="fu">toupper</span>(SEQUENCE_STATUS), <span class="st">"COMPLETE"</span>), <span class="cn">FALSE</span>) <span class="sc">&amp;</span> </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(GISAID_ID) </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"USA/WA-CDC-"</span>, <span class="fu">str_extract</span>(GISAID_ID, <span class="st">"[^-]+"</span>), <span class="st">"/"</span>, <span class="fu">year</span>(SPECIMEN_COLLECTION_DATE)),</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Helix is submitting a full GISAID_ID so no edits necessary - however keeping this here in case future adjustments are necessary     </span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    SUBMITTING_LAB <span class="sc">==</span> <span class="st">"Helix"</span> <span class="sc">&amp;</span> </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">replace_na</span>(<span class="fu">str_detect</span>(<span class="fu">toupper</span>(SEQUENCE_STATUS), <span class="st">"COMPLETE"</span>), <span class="cn">FALSE</span>) <span class="sc">&amp;</span> </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(GISAID_ID) </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">paste0</span>(GISAID_ID),</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Labcorp submits a partial GISAID_ID: append 'hCoV-19/' prefix, append '/[year of collection date]' suffix</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    SUBMITTING_LAB <span class="sc">==</span> <span class="st">"Labcorp"</span> <span class="sc">&amp;</span> </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">replace_na</span>(<span class="fu">str_detect</span>(<span class="fu">toupper</span>(SEQUENCE_STATUS), <span class="st">"COMPLETE"</span>), <span class="cn">FALSE</span>) <span class="sc">&amp;</span> </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(GISAID_ID) </span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"USA/WA-CDC-"</span>, GISAID_ID, <span class="st">"/"</span>, <span class="fu">year</span>(SPECIMEN_COLLECTION_DATE)),</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> GISAID_ID</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="perform-matching" class="level2">
<h2 class="anchored" data-anchor-id="perform-matching">Perform matching</h2>
<p>CASE_IDs from all submitted records will be matched to the WDRS_ENTIRE table using SEQUENCE_CLINICAL_ACCESSION (exact match) and COLLECTION_DATE (+ or - 14 days). The inexact matching is conducted during the quality filters in a later chunk.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [16]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join WDRS CASE_ID to submissions by exact matching on sequence accession number</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>records_matched <span class="ot">&lt;-</span> <span class="fu">left_join</span>(records_mut, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                           wdrs_ent,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"LAB_ACCESSION_ID"</span> <span class="ot">=</span> <span class="st">"FILLER__ORDER__NUM__WDRS"</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">na_matches =</span> <span class="st">"never"</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract unique records</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Necessary step because CASE_ID can be repeated multiple times in WDRS. The join process can generate duplicate rows where each variable value is repeated.</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## This step identifies duplicates using all variables aside from column_label, which contains the filepath of each record and could falsely indicate that a record is unique if it was sent in two separate files</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>records_matched_dedup <span class="ot">&lt;-</span> records_matched[<span class="sc">!</span><span class="fu">duplicated</span>(records_matched[,<span class="dv">2</span><span class="sc">:</span><span class="dv">14</span>]),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>The records_matched_dedup dataframe retains unmatched records in addition to those that were matched. Unmatched records are identifiable by the fact that they have not been assigned a CASE_ID. Next steps will divert the unmatched records to fuzzy matching (if they contain the requisite demographic information) or keep_na. The matched records will then be compiled into the initial roster and undergo subsequent QA checks.</p>
</section>
</section>
<section id="extract-records-for-fuzzy-matching" class="level1">
<h1>Extract records for fuzzy matching</h1>
<p>The next code chunk scans the unnmatched observations and extracts those eligible for fuzzy matching based on the following criteria:</p>
<p>Ineligible for fuzzy matching, proceed towards roster &amp; keep_na: * CASE_ID is not missing (i.e.&nbsp;successfully matched) <em>OR</em> * All demographic columns are NA: FIRST_NAME, LAST_NAME, MIDDLE_NAME, DOB</p>
<p>To fuzzy matching: * CASE_ID is missing (i.e.&nbsp;unmatched) <em>AND</em> * All demographic columns are not NA: FIRST_NAME, LAST_NAME, MIDDLE_NAME, DOB</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [17]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile matched records AND unmatched records without demographic information</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>roster_initial <span class="ot">&lt;-</span> records_matched_dedup[</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">!</span><span class="fu">is.na</span>(records_matched_dedup<span class="sc">$</span>CASE_ID)) <span class="sc">|</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">rowSums</span>(<span class="fu">is.na</span>(records_matched_dedup[, <span class="fu">c</span>(<span class="dv">9</span><span class="sc">:</span><span class="dv">12</span>)])) <span class="sc">==</span> <span class="dv">4</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>, ]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract unmatched records with demographic information for fuzzy matching</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>fuzzy_match <span class="ot">&lt;-</span> records_matched_dedup[</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">is.na</span>(records_matched_dedup<span class="sc">$</span>CASE_ID)) <span class="sc">&amp;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">!</span><span class="fu">rowSums</span>(<span class="fu">is.na</span>(records_matched_dedup[, <span class="fu">c</span>(<span class="dv">9</span><span class="sc">:</span><span class="dv">12</span>)])) <span class="sc">==</span> <span class="dv">4</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>, ]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># If records have been flagged for fuzzy matching, transform and generate output</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(fuzzy_match) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>fuzzy_match_transform <span class="ot">&lt;-</span> fuzzy_match <span class="sc">%&gt;%</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="dv">14</span><span class="sc">:</span><span class="dv">15</span>)) </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="prepare-roster" class="level1 tabset">
<h1 class="tabset">Prepare roster</h1>
<section id="format-roster" class="level2">
<h2 class="anchored" data-anchor-id="format-roster">Format roster</h2>
<p>The next chunk transforms the roster_initial records into the output format used for rostering sequencing results. This dataframe contains matched records AND unmatched records without demographic information. Once mutated into the final roster format, the latter can be diverted to the keep_na list.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [18]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(roster_initial) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  roster_initial_transform <span class="ot">&lt;-</span> roster_initial <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate CASE_ID, as number</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CASE_ID =</span> <span class="fu">as.numeric</span>(CASE_ID)) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_SGTF, populate as blank</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_SGTF =</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_SPECIMEN, populate as "YES"</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_SPECIMEN =</span> <span class="st">"YES"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_REASON, uppercase</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_REASON =</span> <span class="fu">toupper</span>(SEQUENCE_REASON)) <span class="sc">%&gt;%</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_DATE, populate as blank</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_DATE =</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SUBMITTING_LAB, populate with corresponding values</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_LAB =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"AEGIS"</span>) <span class="sc">~</span> <span class="st">"Aegis"</span>,</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"ALTIUS"</span>) <span class="sc">~</span> <span class="st">"Altius"</span>,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"ASU"</span>) <span class="sc">~</span> <span class="st">"ASU"</span>,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"ATLAS"</span>) <span class="sc">~</span> <span class="st">"Atlas Genomics"</span>,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"BOISE VA"</span>) <span class="sc">~</span> <span class="st">"Boise VA"</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"FULGENT"</span>) <span class="sc">~</span> <span class="st">"Fulgent Genetics"</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"GRAVITY"</span>) <span class="sc">~</span> <span class="st">"Gravity"</span>,</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"HELIX"</span>) <span class="sc">~</span> <span class="st">"Helix"</span>,</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"INFINITY"</span>) <span class="sc">~</span> <span class="st">"Infinity"</span>,</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"KAISER"</span>) <span class="sc">~</span> <span class="st">"KP WA Research Inst"</span>,</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"LABCORP"</span>) <span class="sc">~</span> <span class="st">"Labcorp"</span>,</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"LAURING LAB"</span>) <span class="sc">~</span> <span class="st">"Lauring Lab"</span>,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"NW GENOMICS"</span>) <span class="sc">~</span> <span class="st">"NW Genomics"</span>,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"QUEST"</span>) <span class="sc">~</span> <span class="st">"Quest"</span>,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"USAFSA"</span>) <span class="sc">~</span> <span class="st">"USAFSA"</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"UNITED STATES AIR FORCE SCHOOL OF AEROSPACE"</span>) <span class="sc">~</span> <span class="st">"USAFSAM"</span>,</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">str_detect</span>(<span class="fu">toupper</span>(SUBMITTING_LAB), <span class="st">"UW VIROLOGY"</span>) <span class="sc">~</span> <span class="st">"UW Virology"</span>,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> SUBMITTING_LAB)) <span class="sc">%&gt;%</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_STATUS, uppercase</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate(SEQUENCE_STATUS = toupper(SEQUENCE_STATUS)) %&gt;%</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate(SEQUENCE_STATUS = if_else(PANGO_LINEAGE == "Unassigned", "LOW QUALITY", toupper(SEQUENCE_STATUS))) %&gt;%</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">SEQUENCE_STATUS =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>      PANGO_LINEAGE <span class="sc">==</span> <span class="st">"Unassigned"</span> <span class="sc">~</span> <span class="st">"LOW QUALITY"</span>, </span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">toupper</span>(SEQUENCE_STATUS))) <span class="sc">%&gt;%</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_REPOSITORY, populate with "GISAID"</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_REPOSITORY =</span> <span class="st">"GISAID"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_ACCESSION, remove "hCoV-19/" from GISAID_ID</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_ACCESSION =</span> <span class="fu">str_replace</span>(GISAID_ID, <span class="st">"hCoV-19/"</span>, <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_VARIANT_OPEN_TEXT, populate with PANGO_LINEAGE</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_VARIANT_OPEN_TEXT =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">toupper</span>(PANGO_LINEAGE) <span class="sc">%in%</span> <span class="fu">c</span>(lineages_list, <span class="st">"INVALID"</span>) <span class="sc">~</span> PANGO_LINEAGE,</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span> </span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_CLINICAL_ACCESSION, populate with LAB_ACCESSION_ID</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_CLINICAL_ACCESSION =</span> LAB_ACCESSION_ID) <span class="sc">%&gt;%</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_SPECIMEN_COLLECTION_DATE, populate in mdy format</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_SPECIMEN_COLLECTION_DATE =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(<span class="fu">as.Date</span>(roster_initial<span class="sc">$</span>SPECIMEN_COLLECTION_DATE), <span class="st">"%m/%d/%Y"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_NOTES</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_NOTES =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># when PANGO_LINEAGE is not NA, populate into a message with PANGO_LINEAGE and date of processing</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(PANGO_LINEAGE) <span class="sc">~</span> <span class="fu">paste0</span>(<span class="st">"Lineage identified as "</span>, PANGO_LINEAGE, <span class="st">" on "</span>, <span class="fu">today</span>(), <span class="st">". Lineage assignments may change over time."</span>),</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># when PANGO_LINEAGE is not NA, populate as blank</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(PANGO_LINEAGE) <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span> </span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE NOTES for Unassigned records</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">SEQUENCE_NOTES =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(SEQUENCE_VARIANT_OPEN_TEXT) <span class="sc">&amp;</span> SEQUENCE_VARIANT_OPEN_TEXT<span class="sc">!=</span> <span class="st">"Unassigned"</span>, SEQUENCE_NOTES, <span class="cn">NULL</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate SEQUENCE_REVIEWED, populate as blank</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_REVIEWED =</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate Case.Note, populate with message</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Case.Note =</span> <span class="st">"External data question package updated by COVID19 Sequencing Roster."</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select the variables required in the roster</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(CASE_ID, </span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_SGTF, </span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_SPECIMEN, </span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_REASON, </span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_DATE,</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_LAB, </span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_STATUS,</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_REPOSITORY, </span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_ACCESSION, </span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_VARIANT_OPEN_TEXT,</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_CLINICAL_ACCESSION, </span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_SPECIMEN_COLLECTION_DATE,</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_NOTES, </span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_REVIEWED, </span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>         Case.Note</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="extract-records-for-keep_na" class="level2">
<h2 class="anchored" data-anchor-id="extract-records-for-keep_na">Extract records for keep_na</h2>
<p>The next code chunk examines the preliminary roster and removes records for keep_na. Records that qualify for keep_na are unmatched or do not contain sufficient data to be included in the final sequencing roster – they will be retained in the keep_na running list and re-processed by the keep_na script at a future date.</p>
<p>Records designated for keep_na are identified using the following criteria:</p>
<ul>
<li><p>CASE_ID is missing</p></li>
<li><p>SEQUENCE_CLINICAL_ACCESSION is missing</p></li>
<li><p>SEQUENCE_STATUS is COMPLETE and SEQUENCE_ACCESSION is not missing</p></li>
<li><p>SEQUENCE_STATUS is FAILED, NOT DONE, LOW QUALITY, or HIGH CT <em>and</em> SEQUENCE_ACCESSION is missing</p>
<p><em>AND</em></p></li>
<li><p>SEQUENCE_STATUS is not PENDING</p></li>
</ul>
<p>The keep_na records are then checked against the WDRS_FLATTENED table and the running keep_na file to exclude rostered or previously processed records. A variable indicating the date is added to determine the retention time for these records once added to the keep_na file.</p>
<p>The records that are not diverted to keep_na will be sent to undergo final pre-roster QA checks in subsequent chunks.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [19]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Applies a series of logic checks to filter down records don't meet criteria to the keep_na file (often missing CASE_ID)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>keep_na <span class="ot">&lt;-</span> roster_initial_transform[</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CASE_ID is NA or</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  ((<span class="fu">is.na</span>(roster_initial_transform<span class="sc">$</span>CASE_ID)) <span class="sc">|</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SEQUENCE_CLINICAL_ACCESSION is NA or </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">is.na</span>(roster_initial_transform<span class="sc">$</span>SEQUENCE_CLINICAL_ACCESSION)) <span class="sc">|</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># must NOT meet ANY of the conditions to be rostered: </span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>      <span class="do">## (SEQUENCE_STATUS is COMPLETE &amp; SEQUENCE_ACCESSION is not NA) or</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>      <span class="do">## (SEQUENCE_STATUS is FAILED &amp; SEQUENCE_ACCESSION is NA) or</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>      <span class="do">## (SEQUENCE_STATUS is NOT DONE &amp; SEQUENCE_ACCESSION is NA) or</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>      <span class="do">## (SEQUENCE_STATUS is LOW QUALITY &amp; SEQUENCE_ACCESSION is NA) or</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>      <span class="do">## (SEQUENCE_STATUS is HIGH CT &amp; SEQUENCE_ACCESSION is NA)</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>((roster_initial_transform<span class="sc">$</span>SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"COMPLETE"</span>) <span class="sc">&amp;</span> (<span class="sc">!</span><span class="fu">is.na</span>(roster_initial_transform<span class="sc">$</span>SEQUENCE_ACCESSION)) <span class="sc">|</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    (roster_initial_transform<span class="sc">$</span>SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"FAILED"</span>) <span class="sc">&amp;</span> (<span class="fu">is.na</span>(roster_initial_transform<span class="sc">$</span>SEQUENCE_ACCESSION)) <span class="sc">|</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    (roster_initial_transform<span class="sc">$</span>SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"NOT DONE"</span>) <span class="sc">&amp;</span> (<span class="fu">is.na</span>(roster_initial_transform<span class="sc">$</span>SEQUENCE_ACCESSION)) <span class="sc">|</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># (roster_initial_transform$SEQUENCE_STATUS == "LOW QUALITY") &amp; (is.na(roster_initial_transform$SEQUENCE_ACCESSION)) | </span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there are any records with LOW QUALITY that sill have a SEQUENCE_ACCESSION</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    ((roster_initial_transform<span class="sc">$</span>SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"LOW QUALITY"</span>) <span class="sc">&amp;</span> (roster_initial_transform<span class="sc">$</span>SEQUENCE_VARIANT_OPEN_TEXT <span class="sc">==</span> <span class="st">"Unassigned"</span>))  <span class="sc">|</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    (roster_initial_transform<span class="sc">$</span>SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"HIGH CT"</span>) <span class="sc">&amp;</span> (<span class="fu">is.na</span>(roster_initial_transform<span class="sc">$</span>SEQUENCE_ACCESSION))</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">&amp;</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SEQUENCE_STATUS is not PENDING </span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  (roster_initial_transform<span class="sc">$</span>SEQUENCE_STATUS <span class="sc">!=</span> <span class="st">"PENDING"</span>)  </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  , ]</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out records that exist in the WDRS_FLATTENED table or in the running keep_na file, then add a variable containing date processed</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>keep_na_final <span class="ot">&lt;-</span> keep_na[</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SEQUENCE_ACCESSION does not already exist within the WDRS_FLATTENED table and</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">!</span>(keep_na<span class="sc">$</span>SEQUENCE_CLINICAL_ACCESSION <span class="sc">%in%</span> wdrs_sca_flat_values)) <span class="sc">&amp;</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SEQUENCE_CLINICAL_ACCESSION does not already exist within the keep_na  </span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  (<span class="sc">!</span>(keep_na<span class="sc">$</span>SEQUENCE_CLINICAL_ACCESSION <span class="sc">%in%</span> keep_na_running<span class="sc">$</span>SEQUENCE_CLINICAL_ACCESSION)) </span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  , ] <span class="sc">%&gt;%</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a variable documenting the date that the record was processed</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DATE_PROCESSED =</span> <span class="fu">as.character</span>(<span class="fu">today</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="perform-quality-checks" class="level2">
<h2 class="anchored" data-anchor-id="perform-quality-checks">Perform quality checks</h2>
<p>This chunk applies a series of logic checks to identify records that meet criteria to be uploaded and flag those that need manual review (For_Review/to_process). These QA checks are performed by the custom functions found in quality_filters.R.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [20]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>roster_initial_transform_qa <span class="ot">&lt;-</span> roster_initial_transform <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a> <span class="co"># Add COLLECTION_DATE_WDRS column needed for quality filters</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">COLLECTION_DATE_WDRS =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(<span class="fu">as.Date</span>(roster_initial<span class="sc">$</span>SPECIMEN__COLLECTION__DTTM__WDRS), <span class="st">"%m/%d/%Y"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a> <span class="co"># Remove keep_na records</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(keep_na)  </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Applies a series of logic checks to filter down records that meet the criteria to be uploaded into the WDRS_FLATTENED table</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>temp_sub_quality <span class="ot">&lt;-</span> <span class="fu">roster_filters</span>(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                      roster_initial_transform_qa, </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                      lab_vars, </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                      wdrs_flat<span class="sc">$</span>CDC_N_COV_2019_SEQUENCE_ACCESSION_NUMBER, </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                      wdrs_flat<span class="sc">$</span>CDC_N_COV_2019_SEQUENCE_CLINICAL_ACCESSION_NUMBER, </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>                      lineages_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="create-final-roster" class="level2">
<h2 class="anchored" data-anchor-id="create-final-roster">Create final roster</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [21]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any rows that failed quality checks to create final roster</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>roster_final <span class="ot">&lt;-</span> <span class="fu">select</span>(temp_sub_quality, <span class="sc">-</span>COLLECTION_DATE_WDRS) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sum<span class="sc">==</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(CASE_ID<span class="sc">:</span>Case.Note)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="extract-records-for-manual-review" class="level2">
<h2 class="anchored" data-anchor-id="extract-records-for-manual-review">Extract records for manual review</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [22]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract records that triggered quality filter errors to be sent to the For_Review folder</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>for_review <span class="ot">&lt;-</span> <span class="fu">filter</span>(temp_sub_quality, sum<span class="sc">&gt;</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(SEQUENCE_STATUS <span class="sc">!=</span> <span class="st">"FAILED"</span> <span class="sc">&amp;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>         SEQUENCE_STATUS <span class="sc">!=</span> <span class="st">"LOW QUALITY"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(SEQUENCE_ACCESSION <span class="sc">%in%</span> keep_na<span class="sc">$</span>SEQUENCE_ACCESSION))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<hr>
<div class="cell-container"><div class="cell-decorator"><pre>In [23]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Built-in stop before moving any files</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stop</span>(<span class="st">"Stop script before any files are moved. Opportunity to review file validity, final roster, and records sent to keep_na or fuzzy_match."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="generate-output" class="level1">
<h1>Generate output</h1>
<p>For all the output files above, create vectors containing the filepaths and write all output files to their respective destination</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [24]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize vectors to contain the filepaths for all output files in the chunks above</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>roster_final_filepath <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>fuzzy_match_filepath <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>for_review_filepath <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># If there are records in roster_final, output file as a '.csv'</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(roster_final <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create filepath</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  roster_final_filepath <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"write_roster_here/"</span>, <span class="st">"Template_Submitters_"</span>, <span class="fu">format</span>(<span class="fu">now</span>(), <span class="st">"%Y-%m-%d-%H%M%S"</span>), <span class="st">".csv"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to csv</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(roster_final, roster_final_filepath , <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># If there are records in fuzzy_match, output file as a '.csv'</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(fuzzy_match) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create filepath</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  fuzzy_match_filepath <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Submissions/Fuzzy_Match/"</span>, <span class="st">"Template_Submitters_Fuzzy_Match_Required_"</span>, <span class="fu">format</span>(<span class="fu">now</span>(), <span class="st">"%Y-%m-%d-%H%M%S"</span>), <span class="st">".csv"</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to csv</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(fuzzy_match_transform, fuzzy_match_filepath, <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># If there are records in for_review, output file as a '.csv'</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(for_review <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create filepath</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  for_review_filepath <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"For_Review/to_process/"</span>, <span class="st">"For_Review_Template_Submitters_"</span>, <span class="fu">format</span>(<span class="fu">now</span>(), <span class="st">"%Y-%m-%d-%H%M%S"</span>), <span class="st">".csv"</span>)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write to csv</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(for_review, for_review_filepath, <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co"># If there are records in keep_na_final, append the records to the running keep_na file </span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(keep_na_final) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  keep_na_final <span class="sc">%&gt;%</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(<span class="fu">paste0</span>(<span class="st">"keep_na/keep_na.csv"</span>), <span class="at">na =</span> <span class="st">""</span>, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>} </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>Ensure that records were appended to the keep_na file by comparing the number of records in the past and current versions of the object. The difference should equal the nrow of the keep_na_final dataframe created during this script run. If the number of records do not match, output the keep_na_final object to a holding folder to be appended later.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [25]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(keep_na_final) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read in the updated keep_na </span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  keep_na_running_update <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"keep_na/keep_na.csv"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">na =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"N/A"</span>)) </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If the difference in nrow between the previous iteration of keep_na and the updated version does not equal the number of rows in keep_na_final,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> ( (<span class="sc">!</span>( (<span class="fu">nrow</span>(keep_na_running_update)) <span class="sc">-</span> (<span class="fu">nrow</span>(keep_na_running)) ) <span class="sc">==</span> <span class="fu">nrow</span>(keep_na_final) ) ) {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output keep_na_final as a separate file into a holding folder to ensure these data are reviewed</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    keep_na_final <span class="sc">%&gt;%</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write_csv</span>(<span class="fu">paste0</span>(<span class="st">"keep_na/Add_Holding/"</span>, <span class="st">"Template_Submitters_"</span>, <span class="fu">format</span>(<span class="fu">now</span>(), <span class="st">"%Y-%m-%d-%H%M%S"</span>), <span class="st">".csv"</span>), <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="email-receipt" class="level1">
<h1>Email receipt</h1>
<p>Compile an email message by concatenating the vectors created in previous chunks containing relevant messages.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [26]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare email message</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Valid/invalid files</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>valid_files_message <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>valid_files_message <span class="ot">&lt;-</span>  <span class="fu">paste0</span>(valid_files_subset[,<span class="dv">1</span>], <span class="at">collapse=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>final_valid_files_message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"The following file(s) are valid and have been processed:</span><span class="sc">\n</span><span class="st">"</span>, valid_files_message, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Empty files</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>empty_submissions_message <span class="ot">&lt;-</span>  <span class="fu">paste0</span>(empty_submissions, <span class="at">collapse=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Final message</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If the script makes it to this point it will have valid files that were processed -- start with this message and append other potential details</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(final_valid_files_message, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="st">"A total of "</span>, <span class="fu">nrow</span>(roster_final), <span class="st">" records were sent to write_roster_here."</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If there were invalid files, append it to the message</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ((<span class="fu">nrow</span>(invalid_files_subset) <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(message,<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span> , final_invalid_files_message)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If there were empty files, append it to the message</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ((<span class="fu">length</span>(empty_submissions) <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(message, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="st">"The following file(s) were received but contained no data:"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, empty_submissions_message)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## If there were records that required fuzzy matching, append it to the message</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ((<span class="fu">nrow</span>(fuzzy_match) <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(message, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="st">"There are a subset of records from the valid files that were processed that require fuzzy matching. These records do not match to an event in WDRS by an accession ID but do contain viable demographic information:"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, fuzzy_match_filepath)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(message, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="st">"Note: This is an automated message. Please enable your outlook to include extra line breaks to view this message in its proper format."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [27]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Email details</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>email_from <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>email_to <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>email_subj <span class="ot">&lt;-</span> <span class="st">"SEQUENCING - Template Submitters Automated Email"</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>email_body <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Template submission(s) have been processed "</span>, <span class="fu">today</span>(), <span class="st">"."</span>, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, message)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Send email</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>sendmailR<span class="sc">::</span><span class="fu">sendmail</span>(<span class="at">from =</span> email_from,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">to =</span> email_to,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">subject =</span> email_subj,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">msg =</span> email_body,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">headers=</span> <span class="fu">list</span>(<span class="st">"Reply-To"</span> <span class="ot">=</span> email_from),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">smtpServer =</span> <span class="st">""</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>                    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="move-processed-files" class="level1">
<h1>Move processed files</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [28]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create vector of valid files to move</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>move_valid_files <span class="ot">&lt;-</span> valid_files_subset[[<span class="dv">1</span>]]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create vector of valid files and empty files to move</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>move_files <span class="ot">&lt;-</span> <span class="fu">c</span>(move_valid_files, empty_submissions)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># For every file processed, copy from Submissions to the corresponding Completed_Submissions folder and delete original</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## All files should be created successfully, but the script may be unable to delete some files that it considers in use by the R environment. These will be removed by Chunk 10 in the next run prior to identifying new submissions for processing</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(move_files)) {</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Adhoc</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Adhoc"</span>)) {</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Adhoc"</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Aegis</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Aegis"</span>)) {</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Aegis"</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Altius</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Altius"</span>)) {</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Altius"</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ASU</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"ASU"</span>)) {</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/ASU"</span>)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Fulgent Genetics</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Fulgent_Genetics"</span>)) {</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Fulgent_Genetics"</span>)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Gravity Diagnostics</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Gravity Diagnostics"</span>)) {</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Gravity_Diagnostics"</span>)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Helix  </span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Helix"</span>)) {</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Helix"</span>)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Infinity Biologix</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Infinity_Biologix"</span>)) {</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Infinity_Biologix"</span>)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Kaiser</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Kaiser"</span>)) {</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Kaiser"</span>)</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Labcorp</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Labcorp"</span>)) {</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Labcorp"</span>)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Lauring Lab</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"Lauring_Lab"</span>)) {</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/Lauring_Lab"</span>)</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">## NW Genomics</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"NW_Genomics"</span>)) {</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/NW_Genomics"</span>)</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>  <span class="do">## United States Air Force</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"UnitedStatesAirForceSchoolofAerospace"</span>)) {</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/USAFSAM"</span>)</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>  <span class="do">## UW Virology</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">str_detect</span>(move_files[i], <span class="st">"UW_Virology"</span>)) {</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.copy</span>(move_files[i], <span class="st">"Completed_Submissions/UW_Virology"</span>)</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(move_files[i])</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Update completed files list for next time</span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(<span class="fu">as.data.frame</span>(move_files), <span class="st">"Completed_Submissions/Template_Submitters/Template_Submitters_File_Completed.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>  </div> <!-- /content --> 
  
</body></html>