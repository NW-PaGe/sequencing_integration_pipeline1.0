<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.5.22">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

    <meta name="author" content="Emily Nebergall and Allie Warren">
    <meta name="dcterms.date" content="2024-03-26">

    <title>Fuzzy Matching Script</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
      /* CSS for syntax highlighting */
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "../index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="../site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
     <script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>  
      </head>

  <body class="quarto-notebook">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Fuzzy Matching Script</h6>

            <a href="../notebooks/fuzzy.Rmd" class="btn btn-primary quarto-download-embed" download="fuzzy.Rmd">Download Notebook</a>
          </div>

     <header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Fuzzy Matching Script</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
        
        <div class="quarto-title-meta">

                <div>
            <div class="quarto-title-meta-heading">Author</div>
            <div class="quarto-title-meta-contents">
                        <p>Emily Nebergall and Allie Warren </p>
                      </div>
          </div>
                
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">March 26, 2024</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#libraries" id="toc-libraries" class="nav-link" data-scroll-target="#libraries">Libraries</a></li>
  </ul></li>
  <li><a href="#important-objects" id="toc-important-objects" class="nav-link" data-scroll-target="#important-objects">Important Objects</a></li>
  <li><a href="#submitter-data" id="toc-submitter-data" class="nav-link" data-scroll-target="#submitter-data">Submitter data</a>
  <ul class="collapse">
  <li><a href="#wdrs-data" id="toc-wdrs-data" class="nav-link" data-scroll-target="#wdrs-data">WDRS Data</a>
  <ul class="collapse">
  <li><a href="#open-connection-to-wdrs" id="toc-open-connection-to-wdrs" class="nav-link" data-scroll-target="#open-connection-to-wdrs">Open connection to WDRS</a></li>
  <li><a href="#wdrs-entire-table" id="toc-wdrs-entire-table" class="nav-link" data-scroll-target="#wdrs-entire-table">WDRS Entire table</a></li>
  <li><a href="#wdrs-flattened-table" id="toc-wdrs-flattened-table" class="nav-link" data-scroll-target="#wdrs-flattened-table">WDRS Flattened table</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#initial-quality-checks" id="toc-initial-quality-checks" class="nav-link" data-scroll-target="#initial-quality-checks">Initial Quality Checks</a>
  <ul class="collapse">
  <li><a href="#fixing-sa-format" id="toc-fixing-sa-format" class="nav-link" data-scroll-target="#fixing-sa-format">Fixing SA Format</a></li>
  <li><a href="#missing-demographics" id="toc-missing-demographics" class="nav-link" data-scroll-target="#missing-demographics">Missing Demographics</a></li>
  <li><a href="#pre-match-quality-checks" id="toc-pre-match-quality-checks" class="nav-link" data-scroll-target="#pre-match-quality-checks">Pre-Match Quality Checks</a></li>
  <li><a href="#print-pre-match-errors" id="toc-print-pre-match-errors" class="nav-link" data-scroll-target="#print-pre-match-errors">Print Pre-Match Errors</a></li>
  <li><a href="#clean-data-sent-to-rosters" id="toc-clean-data-sent-to-rosters" class="nav-link" data-scroll-target="#clean-data-sent-to-rosters">Clean Data Sent to Rosters</a></li>
  </ul></li>
  <li><a href="#fuzzy-matching" id="toc-fuzzy-matching" class="nav-link" data-scroll-target="#fuzzy-matching">Fuzzy matching</a></li>
  <li><a href="#transformations-and-post-matching-quality-filters" id="toc-transformations-and-post-matching-quality-filters" class="nav-link" data-scroll-target="#transformations-and-post-matching-quality-filters">Transformations and Post-matching Quality Filters</a>
  <ul class="collapse">
  <li><a href="#modify-date-types" id="toc-modify-date-types" class="nav-link" data-scroll-target="#modify-date-types">modify date types</a></li>
  <li><a href="#filter-data-on-matching-dob" id="toc-filter-data-on-matching-dob" class="nav-link" data-scroll-target="#filter-data-on-matching-dob">Filter data on matching DOB</a></li>
  <li><a href="#no-case_id-assigned" id="toc-no-case_id-assigned" class="nav-link" data-scroll-target="#no-case_id-assigned">No CASE_ID assigned</a></li>
  <li><a href="#fuzzy-roster-transformations" id="toc-fuzzy-roster-transformations" class="nav-link" data-scroll-target="#fuzzy-roster-transformations">Fuzzy Roster Transformations</a></li>
  <li><a href="#collection-date-filter" id="toc-collection-date-filter" class="nav-link" data-scroll-target="#collection-date-filter">Collection Date Filter</a>
  <ul class="collapse">
  <li><a href="#filter-data-on-14-day-window" id="toc-filter-data-on-14-day-window" class="nav-link" data-scroll-target="#filter-data-on-14-day-window">Filter Data on 14 Day Window</a></li>
  <li><a href="#collection-date-mismatch" id="toc-collection-date-mismatch" class="nav-link" data-scroll-target="#collection-date-mismatch">Collection Date Mismatch</a></li>
  </ul></li>
  <li><a href="#case-counts" id="toc-case-counts" class="nav-link" data-scroll-target="#case-counts">Case Counts</a></li>
  </ul></li>
  <li><a href="#print-rosters" id="toc-print-rosters" class="nav-link" data-scroll-target="#print-rosters">Print Rosters</a>
  <ul class="collapse">
  <li><a href="#perfect-matches" id="toc-perfect-matches" class="nav-link" data-scroll-target="#perfect-matches">Perfect Matches</a></li>
  <li><a href="#fuzzy1" id="toc-fuzzy1" class="nav-link" data-scroll-target="#fuzzy1">Fuzzy1</a></li>
  <li><a href="#fuzzy2" id="toc-fuzzy2" class="nav-link" data-scroll-target="#fuzzy2">Fuzzy2</a></li>
  <li><a href="#fuzzy3" id="toc-fuzzy3" class="nav-link" data-scroll-target="#fuzzy3">Fuzzy3</a></li>
  </ul></li>
  <li><a href="#wrap-up" id="toc-wrap-up" class="nav-link" data-scroll-target="#wrap-up">Wrap-UP</a>
  <ul class="collapse">
  <li><a href="#saved-rows" id="toc-saved-rows" class="nav-link" data-scroll-target="#saved-rows">Saved Rows</a></li>
  <li><a href="#move-files" id="toc-move-files" class="nav-link" data-scroll-target="#move-files">Move Files</a></li>
  <li><a href="#completed-email" id="toc-completed-email" class="nav-link" data-scroll-target="#completed-email">Completed Email</a></li>
  </ul></li>
  <li><a href="#update-fuzzy-for-review-running-list" id="toc-update-fuzzy-for-review-running-list" class="nav-link" data-scroll-target="#update-fuzzy-for-review-running-list">Update fuzzy for review running list</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">      

       <div class="cell-container"><div class="cell-decorator"><pre>In [1]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The COVID Sequencing project matches lab-submitted COVID test sequencing records with WDRS COVID test result records. Usually this matching process is accomplished by matching clinical accession numbers that are assigned to COVID test specimens by the testing lab and which remain attached to the specimen through the sequencing process. However, some sequencing records are submitted without the clinical accession number, or the clinical accession number that accompanies the sequencing record does not match any COVID test specimen clinical accession in the WDRS Flattened or Entire tables. For sequencing records that cannot match to a test specimen in WDRS via a clinical accession specimen id, patient demographics provide an alternative matching option.</p>
<p>The FUZZY_MATCHING script uses <code>fuzzyjoin::stringdist_left_join()</code> to perform <a href="https://en.wikipedia.org/wiki/Damerau%E2%80%93Levenshtein_distance">optimal string alignment</a> on patient name and date of birth data to match lab-submitted sequencing data to COVID test specimen records in the WDRS Flattened and Entire tables.</p>
</section>
<section id="setup" class="level1 tabset">
<h1 class="tabset">Setup</h1>
<section id="libraries" class="level2">
<h2 class="anchored" data-anchor-id="libraries">Libraries</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [2]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fuzzyjoin)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(odbc)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="important-objects" class="level1">
<h1>Important Objects</h1>
<p>This script uses several custom functions which are shared by other scripts in the Sequencing project. These shared custom functions are stored in the quality_filters.R script, which is called here using the <code>source()</code> function. The script also uses a table of</p>
<p>Three sources of data are imported into this script. Valid lineage data is brought into help assure data quality. Submitter sequencing records are imported from the Submissions/Fuzzy_Match/ subdirectory of <code>project_folder</code>, either the project directory on the net drive (test mode = FALSE) or the same folder in a local clone (test mode = TRUE). And finally, WDRS is queried for COVID test records which must be matched to the new sequencing data.</p>
<p>VOC.RDS contains the list of variants of concern and is needed to populate the SEQUENCE_VARIANT column. The lineages object is updated [how often] by the _________________ script. VOC.RDS is declared in the .gitignore file as the only .RDS object allowed to pass to GitHub, as it does not contain any secrets, and it must be updated in order for roster-generating scripts to run properly.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [3]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in r_creds.RDS</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>r_creds <span class="ot">&lt;-</span><span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="fu">Sys.getenv</span>(<span class="st">"USERPROFILE"</span>), <span class="st">"Projects/Sequencing/Data_Objects"</span>, <span class="st">"r_creds.RDS"</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in quality_filters</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(<span class="fu">Sys.getenv</span>(<span class="st">"USERPROFILE"</span>), <span class="st">"Projects/Sequencing/Roster_scripts/quality_filters.R"</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in functions for performing fuzzy matching</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(<span class="fu">Sys.getenv</span>(<span class="st">"USERPROFILE"</span>), <span class="st">"Projects/Sequencing/Roster_scripts/fuzzy_matching_functions.R"</span>))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># shared lab variable lists</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>lab_vars <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Data_Objects/lab_variables.rds"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>voc <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"Data_Objects/VOC/VOC.Rds"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>lineages <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data_Objects/Lineages/Lineages.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">lineages =</span> lineage_extracted)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>valid_lineages <span class="ot">&lt;-</span> lineages<span class="sc">$</span>lineages</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Appending Unassigned lineage to avoid for review</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>valid_lineages <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  valid_lineages, </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"UNASSIGNED"</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Unassigned"</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="submitter-data" class="level1">
<h1>Submitter data</h1>
<p>Data for fuzzy matching gets sent to the Fuzzy_Match folder in the Submissions subdirectory of the sequencing project. Each run of this script produces a saved_rows.csv file which contains rows that were not printed to any other file during the course of the run. While efforts are made to capture and funnel all of the data to some product in this script, this matching process is complex and saved_rows serves as a safety net to prevent data loss. saved_rows and the new files sent to fuzzy matching from the PHL and TEMPLATE_SUBMITTERS scripts are imported using <code>readr::read_csv()</code>, and compiled using <code>plyr::rbind.fill()</code>. Base R’s <code>unique()</code> removes duplicate rows, which may occur when cumulative files such as the PHL download are run repeatedly through a transformation script before this fuzzy matching process is performed.</p>
<p>Files imported in this code chunk are combined using <code>plyr::rbind.fill()</code> because at the time of writing this script, data sent from the template submitters and PHL processes were producing different sets of columns. the <code>rbind.fill()</code> function allows for two files with slightly different column to be combined; all the columns will be preserved and blank cells will be added for rows that did not originally contain columns from the other files.</p>
<p>As a part of this data import, a unique row id is assigned using <code>tibble::rowid_to_column()</code> to avoid generating duplication events when records lack any unique identifier such as a sequence clinical accession or sequence accession, as sometimes happens when failed sequencing records (which do not require a sequence accession) also lack a sequence clinical accession.</p>
<p><strong>rows_printed</strong>: the empty object rows_printed is created here. Throughout the script, this object will receive the rowid’s of records that are printed to any file. This conveniently allows us to see (if running the script manually) how many rows fall to each of the various output. At the end of the script, any records from the original input data whose rowid is NOT in rows_printed is passed to a saved_rows file which is printed to a subfolder of the fuzzy matches submissions folder and read into the next fuzzy matching session. This file is almost always empty, but it is beneficial to regularly check it to see if and how many records are not being captured by the script. This may indicate some change in the submitter data being received.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [4]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a list of the columns we want to bring into this process</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># input columns for fuzzy matching data</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>fuzz_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SEQUENCE_REASON"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"GISAID_ID"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"PANGO_LINEAGE"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"FIRST_NAME"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"LAST_NAME"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"MIDDLE_NAME"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"SUBMITTING_LAB"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"DOB"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"SPECIMEN_COLLECTION_DATE"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"SEQUENCE_STATUS"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ALTERNATIVE_ID"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"LAB_ACCESSION_ID"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># rows from the previous fuzzy match run that were not printed to any other file; a safety net to prevent data loss</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>saved_rows_file <span class="ot">&lt;-</span> <span class="fu">dir_ls</span>(<span class="st">"Submissions/Fuzzy_Match/rows_not_yet_printed"</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(saved_rows_file) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  saved_rows <span class="ot">&lt;-</span> saved_rows_file <span class="sc">%&gt;%</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_df</span>( <span class="sc">~</span> <span class="fu">read_csv</span>(</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      .,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">col_types =</span> <span class="fu">cols</span>(</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">SEQUENCE_REASON =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">GISAID_ID =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">PANGO_LINEAGE =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">FIRST_NAME =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">LAST_NAME =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">MIDDLE_NAME =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">SUBMITTING_LAB =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">DOB =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">SPECIMEN_COLLECTION_DATE =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">SEQUENCE_STATUS =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">ALTERNATIVE_ID =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">LAB_ACCESSION_ID =</span> <span class="fu">col_character</span>()</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>      plyr<span class="sc">::</span><span class="fu">rbind.fill</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(fuzz_cols)) <span class="sc">%&gt;%</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>()</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if no inputs here, inititalize empty data frame</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  saved_rows <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol=</span><span class="fu">length</span>(fuzz_cols), <span class="at">nrow =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(fuzz_cols)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co"># new files produced by the PHL and template submitter script</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>fuzz_new_file <span class="ot">&lt;-</span> <span class="fu">dir_ls</span>(<span class="st">"Submissions/Fuzzy_Match"</span>, <span class="at">type =</span> <span class="st">"file"</span>)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(fuzz_new_file) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  fuzz_new <span class="ot">&lt;-</span> fuzz_new_file <span class="sc">%&gt;%</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_df</span>( <span class="sc">~</span> <span class="fu">read_csv</span>(</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      .,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">col_types =</span> <span class="fu">cols</span>(</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">SEQUENCE_REASON =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">GISAID_ID =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">PANGO_LINEAGE =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">FIRST_NAME =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">LAST_NAME =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">MIDDLE_NAME =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">SUBMITTING_LAB =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">DOB =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">SPECIMEN_COLLECTION_DATE =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">CASE_ID =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">SEQUENCE_STATUS =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">ALTERNATIVE_ID =</span> <span class="fu">col_character</span>(),</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">LAB_ACCESSION_ID =</span> <span class="fu">col_character</span>()</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>      plyr<span class="sc">::</span><span class="fu">rbind.fill</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">all_of</span>(fuzz_cols)) <span class="sc">%&gt;%</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>()</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if not inputs. initialize empty data frame</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  fuzz_new <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol=</span><span class="fu">length</span>(fuzz_cols), <span class="at">nrow =</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> magrittr<span class="sc">::</span><span class="fu">set_colnames</span>(fuzz_cols)</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="co"># rbind.fill() adds saved_rows to the fuzz_new file, allowing for columns to be different between files. </span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="co"># create a unique row id using the index</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>fuzz <span class="ot">&lt;-</span> fuzz_new <span class="sc">%&gt;%</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(saved_rows) <span class="sc">%&gt;%</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rowid_to_column</span>()</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>rows_printed <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">nrow</span>(fuzz))</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a><span class="co"># If no records for fuzzy matching, send out the email and </span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co"># stop the script</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(fuzz) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>     sendmailR<span class="sc">::</span><span class="fu">sendmail</span>(</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> <span class="st">""</span>,</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">to =</span> <span class="fu">c</span>(</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"Sequencing - COVID Sequencing Fuzzy Match script complete"</span>,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">msg =</span> <span class="fu">paste0</span>(<span class="st">"Fuzzy matching script for "</span>, <span class="fu">today</span>(), <span class="st">" is complete, there were no inputs to fuzzy matching."</span>),</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">headers =</span> <span class="fu">list</span>(<span class="st">"Reply-To"</span> <span class="ot">=</span> <span class="st">""</span>),</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">smtpServer =</span> <span class="st">""</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"No inputs to fuzzy matching"</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<section id="wdrs-data" class="level2">
<h2 class="anchored" data-anchor-id="wdrs-data">WDRS Data</h2>
<section id="open-connection-to-wdrs" class="level3">
<h3 class="anchored" data-anchor-id="open-connection-to-wdrs">Open connection to WDRS</h3>
<p><strong>IMPORTANT</strong> the variables used to connect to WDRS are held within conn_list.RDS, you will need to make your own private .RDS.</p>
<p>We do not include server connections in code uploaded to GitHub.</p>
<p><strong>So: DO NOT alter the code used to open the connection to WDRS in any way that creates a security risk. Continue to treat this connection as a secret and store its variables in a .RDS object (or other external object that is excluded from Git commits) rather than calling them directly here.</strong></p>
<div class="cell-container"><div class="cell-decorator"><pre>In [5]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># connect</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>connection <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(odbc<span class="sc">::</span><span class="fu">odbc</span>(), </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Driver =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">1</span>], </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Server =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">2</span>], </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Database =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">3</span>], </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">Trusted_connection =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">4</span>], </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ApplicationIntent =</span> r_creds<span class="sc">$</span>conn_list[<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="wdrs-entire-table" class="level3">
<h3 class="anchored" data-anchor-id="wdrs-entire-table">WDRS Entire table</h3>
<p>WDRS demographics data for fuzzy matching</p>
<p>There are two different types of columns where name data is found in the entire table. The data is pulled into R using a SQL query. The custom function annihilate cleans the data to remove floating initials, punctuation, and extra spaces; check the Important Functions Wiki page in the repository for more information.</p>
<p>PATIENT__FIRSTNAME and FIRST_NAME (substitute LAST for last names) are both filled with patient name data, and sometimes a name is found in one column but not in another. Therefore, both columns are queried. In the code chunk ‘wdrs names’ below ‘wdrs_entire’, a single name column is created by filling in missing data with data present in the alternate column.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [6]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># wdrs_entire &lt;- xfun::cache_rds({</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  wdrs_entire <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    connection,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT Distinct CASE_ID,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">      [PATIENT__FIRSTNAME] as FNAME,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="st">      [PATIENT__LASTNAME] as LNAME,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="st">      [FILLER__ORDER__NUM] as SpecimenId,</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="st">      [PATIENT__DATE__OF__BIRTH] as DOB_WDRS,</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">      [SPECIMEN__COLLECTION__DTTM] as COLLECTION_DATE_WDRS,</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="st">      [FIRST_NAME] as FIRST_NAME,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="st">      [LAST_NAME] as LAST_NAME</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM [dbo].[DD_ELR_DD_ENTIRE] WHERE CODE = 'SARS'</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="st">  AND STATUS != '6' </span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="st">  AND WDRS__RESULT__SUMMARY != 'NEGATIVE'"</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># clean up WDRS names, remove characters that are not alphanumeric, remove white spaces</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  wdrs_entire_names <span class="ot">&lt;-</span> wdrs_entire <span class="sc">%&gt;%</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">FNAME =</span> <span class="fu">annihilate</span>(wdrs_entire<span class="sc">$</span>FNAME),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">LNAME =</span> <span class="fu">annihilate</span>(wdrs_entire<span class="sc">$</span>LNAME),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">SpecimenId =</span> <span class="fu">as.character</span>(SpecimenId),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">FIRST_NAME =</span> <span class="fu">annihilate</span>(wdrs_entire<span class="sc">$</span>FIRST_NAME),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">LAST_NAME =</span> <span class="fu">annihilate</span>(wdrs_entire<span class="sc">$</span>LAST_NAME)) <span class="sc">%&gt;%</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unite</span>(NAME_WDRS,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(FNAME, LNAME),</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">remove =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>          <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unite</span>(ALT_NAME_WDRS,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">c</span>(FIRST_NAME, LAST_NAME),</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>          <span class="at">remove =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co"># },</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># rerun = FALSE,</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># file = "wdrs_query")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [7]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine PATIENT NAME and NAME columns</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>wdrs_entire <span class="ot">&lt;-</span> wdrs_entire_names <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">NAME_WDRS =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      NAME_WDRS <span class="sc">==</span> <span class="st">""</span> <span class="sc">~</span> ALT_NAME_WDRS,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      NAME_WDRS <span class="sc">!=</span> <span class="st">""</span> <span class="sc">~</span> NAME_WDRS)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get records where the PATIENT NAME and NAME columns differ</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>alt_wdrs_name <span class="ot">&lt;-</span> <span class="fu">filter</span>(wdrs_entire, NAME_WDRS <span class="sc">!=</span> ALT_NAME_WDRS) <span class="sc">%&gt;%</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAME_WDRS =</span> ALT_NAME_WDRS)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add rows using the alternate name, duplicating the other columns</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>wdrs_entire <span class="ot">&lt;-</span> <span class="fu">rbind.data.frame</span>(wdrs_entire, alt_wdrs_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="wdrs-flattened-table" class="level3">
<h3 class="anchored" data-anchor-id="wdrs-flattened-table">WDRS Flattened table</h3>
<p>Sequencing results are entered into the flattened table, tied to the CASE_ID from the COVID test record found in the entire table. In order to prevent the entry of duplicate records to WDRS, we query the flattened table for sequence accession numbers tied to COVID test record CASE_ID’s, and use these data to deduplicate input data that may have been submitted repeatedly.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [8]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># wdrs_sa_flat &lt;- xfun::cache_rds({</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  wdrs_sa_flat <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    connection,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT DISTINCT CDC_N_COV_2019_SEQUENCE_ACCESSION_NUMBER,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">     CDC_N_COV_2019_SEQUENCE_CLINICAL_ACCESSION_NUMBER,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">     CASE_ID,</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="st">     BIRTH_DATE</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="st">     FROM [dbo].[DD_GCD_COVID_19_FLATTENED]</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="st">     "</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># },</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># file = "wdrs_sa_flat")</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># for fields that have multiple comma separated SEQUENCE_ACCESSION's split them by ","</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>wdrs_sa_flat_split <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">str_split</span>(wdrs_sa_flat[[<span class="dv">1</span>]], <span class="st">","</span>))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># omit any NA's</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>wdrs_sa_flat_clean <span class="ot">&lt;-</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  wdrs_sa_flat_split[<span class="sc">!</span><span class="fu">is.na</span>(wdrs_sa_flat_split)] <span class="sc">%&gt;%</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#for fields that have "hCoV-19/" appended to the beginning of the SEQUENCE_ACCESSION remove it by str_replace() with ""</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_replace</span>(<span class="st">"hCoV-19/"</span>, <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># trim off the white space resulting from str_split, this also gets rid of " " values</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_trim</span>(<span class="st">"both"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any values that are ""</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>wdrs_sa_flat_values <span class="ot">&lt;-</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  wdrs_sa_flat_clean[wdrs_sa_flat_clean <span class="sc">!=</span> <span class="st">""</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [9]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for fields that have multiple comma separated SEQUENCE_ACCESSION's split them by ","</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>wdrs_sca_flat_split <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">str_split</span>(wdrs_sa_flat[[<span class="dv">2</span>]], <span class="st">","</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># omit any NA's</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>wdrs_sca_flat_clean <span class="ot">&lt;-</span> wdrs_sca_flat_split[<span class="sc">!</span><span class="fu">is.na</span>(wdrs_sca_flat_split)] <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#for fields that have "hCoV-19/" appended to the beginning of the SEQUENCE_ACCESSION remove it by str_replace() with ""</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_replace</span>(<span class="st">"hCoV-19/"</span>, <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># trim off the white space resulting from str_split, this also gets rid of " " values  </span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_trim</span>(<span class="st">"both"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># remove any values that are ""</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>wdrs_sca_flat_values <span class="ot">&lt;-</span> wdrs_sca_flat_clean[wdrs_sca_flat_clean <span class="sc">!=</span> <span class="st">""</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [10]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># some records in the WDRS ENTIRE table don't have a DOB, but that data is present for matching records </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in the WDRS flattened table - replace DOB data with data from flattened table</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>wdrs_entire <span class="ot">&lt;-</span> <span class="fu">left_join</span>(wdrs_entire, wdrs_sa_flat, <span class="at">by =</span> <span class="st">'CASE_ID'</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>wdrs_entire <span class="ot">&lt;-</span> wdrs_entire <span class="sc">%&gt;%</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DOB_WDRS =</span> <span class="fu">case_when</span>((<span class="fu">is.na</span>(DOB_WDRS) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(BIRTH_DATE)) <span class="sc">~</span> BIRTH_DATE,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                              <span class="cn">TRUE</span> <span class="sc">~</span> DOB_WDRS)) </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># if the WDRS entire and WDRS flattened table have different DOB, add a duplicate record with the alternate DOB (same method used for alt name)</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get records where the DOB_WDRS and BIRTH_DATE columns differ</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>alt_wdrs_dob <span class="ot">&lt;-</span> <span class="fu">filter</span>(wdrs_entire, DOB_WDRS <span class="sc">!=</span> BIRTH_DATE) <span class="sc">%&gt;%</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DOB_WDRS =</span> BIRTH_DATE)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add rows using the alternate name, duplicating the other columns, remove unused columns</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>wdrs_entire <span class="ot">&lt;-</span> <span class="fu">rbind.data.frame</span>(wdrs_entire, alt_wdrs_dob) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>CDC_N_COV_2019_SEQUENCE_ACCESSION_NUMBER,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                                                           <span class="sc">-</span>CDC_N_COV_2019_SEQUENCE_CLINICAL_ACCESSION_NUMBER, <span class="sc">-</span>BIRTH_DATE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
</section>
<section id="initial-quality-checks" class="level1 tabset">
<h1 class="tabset">Initial Quality Checks</h1>
<section id="fixing-sa-format" class="level2">
<h2 class="anchored" data-anchor-id="fixing-sa-format">Fixing SA Format</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [11]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># format GISAID ID - removing hcov-19 from the SA</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>fuzz_fix_sa_format <span class="ot">&lt;-</span> fuzz <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GISAID_ID =</span> <span class="fu">str_replace</span>(GISAID_ID, <span class="st">"hCoV-19/"</span>, <span class="st">""</span>))</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#code to remove sequence accessions with a bad format that was encountered with LabCorp specimens for a short time; obsolete, retaining in case of re-occurance</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># fuzz_clean &lt;- fuzz %&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(!(GISAID_ID %in% wdrs_sa_flat_values),</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#          !(str_detect(GISAID_ID, "USA/WA-CDC-WA-CDC-*")))</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># fuzz_wrong &lt;- fuzz %&gt;%</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(str_detect(GISAID_ID, "USA/WA-CDC-WA-CDC-*")) </span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # if(nrow(fuzz_wrong) &gt; 0) {</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># #   write_csv(fuzz_wrong, paste0(project_folder, </span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># #                                       "//Fuzzy_matches//Fuzzy_Error_Checks//fuzzy_bad_SA_format_", </span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># #                                       today(), </span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># #                                       ".csv"))</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># #   </span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># #   rows_printed &lt;- rows_printed %&gt;% append(fuzz_wrong$rowid)</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># #   </span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># #   print(paste(length(rows_printed), "of", nrow(fuzz), "rows have been printed"))</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># # }</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="missing-demographics" class="level2">
<h2 class="anchored" data-anchor-id="missing-demographics">Missing Demographics</h2>
<p>Before data can be filtered, one correction to date data for birth dates must be made. Excel dates have arrived in the birth date column and are not transformed to any known format in R when the file is read in using read_csv. The custom function <code>convert_excel_date()</code> transforms these 4-5 digit strings to mm-dd-yyyy format. See the Important Functions Wike page for more details.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [12]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#transform dates that are in excel format to yyyy-mm-dd. keep NA rows so that they are filtered along with other preprocessing errors</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>fuzz_fix_excel_dates <span class="ot">&lt;-</span> fuzz_fix_sa_format <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DOB =</span> <span class="fu">case_when</span>(<span class="fu">detect_date_format</span>(DOB) <span class="sc">~</span> <span class="fu">as.character</span>(DOB),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">str_detect</span>(DOB, <span class="st">"^[[:digit:]]{4,5}$"</span>) <span class="sc">~</span> <span class="fu">as.character</span>(<span class="fu">convert_excel_date</span>(DOB)),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                         <span class="cn">TRUE</span> <span class="sc">~</span> DOB))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="pre-match-quality-checks" class="level2">
<h2 class="anchored" data-anchor-id="pre-match-quality-checks">Pre-Match Quality Checks</h2>
<p>Columns are added to the data that check for specific errors and add a 1 to the rows where the error check is positive. These error checks include the relevant checks from the <code>roster_filters()</code> function; see the Important Functions Wiki page for more details. It is important to note that the deduplication process for Fuzzy Matching does not involved the Sequence Clinical Accession as many rows arrive here without that identifier. We do however deduplicate both internally and against WDRS by sequence accession.</p>
<p>Rows with positive errors are filtered out at the end of this error check process and sent to For_Review/to_process_fuzzy_match/fuzzy_pre_match_quality_filter_today.csv”</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [13]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create columns for each condition that must be met in order for the data to be rostered to wdrs</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>fuzzy_pre_match_quality <span class="ot">&lt;-</span> fuzz_fix_excel_dates <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_REASON =</span> <span class="fu">toupper</span>(SEQUENCE_REASON))<span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_STATUS =</span> <span class="fu">if_else</span>(<span class="fu">str_detect</span>(PANGO_LINEAGE,<span class="st">"Unas"</span>),<span class="st">"LOW QUALITY"</span>,<span class="fu">toupper</span>(SEQUENCE_STATUS)))<span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that GISAID_ID (sequence accession) doesn't show up more than once</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_SA_INT_DUPE =</span> <span class="fu">case_when</span>(<span class="sc">!</span>(<span class="fu">is.na</span>(GISAID_ID) <span class="sc">|</span> GISAID_ID <span class="sc">==</span> <span class="st">""</span>) <span class="sc">&amp;</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                                        GISAID_ID <span class="sc">%in%</span> GISAID_ID[<span class="fu">duplicated</span>(GISAID_ID)] <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that GISAID_ID (sequence accession) isn't already in WDRS</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_SA_WDRS_DUPE =</span> <span class="fu">case_when</span>(GISAID_ID <span class="sc">%in%</span> wdrs_sa_flat_values <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that lineage is not NA or None and is in expected list</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_SEQ_VARIANT =</span> <span class="fu">case_when</span>(<span class="fu">str_detect</span>(<span class="fu">toupper</span>(PANGO_LINEAGE), <span class="st">"NONE|^NA"</span>) <span class="sc">|</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                                      (<span class="sc">!</span>PANGO_LINEAGE <span class="sc">%in%</span> valid_lineages <span class="sc">&amp;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                                         <span class="sc">!</span>(<span class="fu">is.na</span>(PANGO_LINEAGE) <span class="sc">|</span> PANGO_LINEAGE <span class="sc">==</span> <span class="st">""</span>)) <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that sequence status is COMPLETE, FAILED, or LOW QUALITY and</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that GISAID_ID (sequence accession) exists/doesn't exist for various statuses</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_SEQ_STAT =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(SEQUENCE_STATUS) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                            <span class="sc">!</span>SEQUENCE_STATUS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'COMPLETE'</span>, <span class="st">'FAILED'</span>, <span class="st">'LOW QUALITY'</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                                   <span class="co"># error when status is complete but sa is missing,</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                                   SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"COMPLETE"</span> <span class="sc">&amp;</span> (<span class="fu">is.na</span>(GISAID_ID) <span class="sc">|</span> GISAID_ID <span class="sc">==</span> <span class="st">""</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># error when status is not complete and sa is not missing</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                                    SEQUENCE_STATUS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"FAILED"</span>,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"NOT DONE"</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"HIGH CT"</span>) <span class="sc">&amp;</span> <span class="sc">!</span>(<span class="fu">is.na</span>(GISAID_ID) <span class="sc">|</span> GISAID_ID <span class="sc">==</span> <span class="st">""</span>) <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that sequence reason is valid for the submitting lab</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_SEQ_REASON =</span> <span class="fu">case_when</span>(SUBMITTING_LAB <span class="sc">%in%</span> lab_vars<span class="sc">$</span>cdc_labs <span class="sc">&amp;</span> <span class="sc">!</span>(SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>input_seq_reasons_cdc) <span class="sc">|</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        (<span class="sc">!</span>(SUBMITTING_LAB <span class="sc">%in%</span> <span class="fu">c</span>(lab_vars<span class="sc">$</span>cdc_labs, <span class="st">"PHL"</span>)) <span class="sc">&amp;</span> <span class="sc">!</span>(SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>input_seq_reasons_non_cdc)) <span class="sc">|</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        (SUBMITTING_LAB <span class="sc">==</span> <span class="st">"PHL"</span> <span class="sc">&amp;</span> <span class="sc">!</span>(SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>input_seq_reasons_phl))</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>       <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that lineage exists/does not exist for various sequence statuses</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_SEQ_NOTES =</span> <span class="fu">case_when</span>((SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"COMPLETE"</span>) <span class="sc">&amp;</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>                                       (<span class="fu">is.na</span>(PANGO_LINEAGE)) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>                             (SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"FAILED"</span>) <span class="sc">&amp;</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>                                         (PANGO_LINEAGE <span class="sc">!=</span> <span class="st">""</span>) <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that record has name</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_NAME_NA =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(FIRST_NAME) <span class="sc">&amp;</span> <span class="fu">is.na</span>(LAST_NAME) <span class="sc">&amp;</span> <span class="fu">is.na</span>(MIDDLE_NAME) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">str_detect</span>(FIRST_NAME,<span class="st">"[[:digit:]]"</span>) <span class="sc">|</span> <span class="fu">str_detect</span>(LAST_NAME,<span class="st">"[[:digit:]]"</span>) <span class="sc">|</span> <span class="fu">str_detect</span>(MIDDLE_NAME,<span class="st">"[[:digit:]]"</span>) <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that record has DOB and is in the correct format</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_DOB_NA =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(DOB) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>                          DOB <span class="sc">==</span> <span class="st">"1899-12-30"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>                          <span class="sc">!</span><span class="fu">detect_date_format</span>(DOB) <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check that record has collection date and is in the correct format</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">QA_COLLECT_DATE_NA =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(SPECIMEN_COLLECTION_DATE) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">is.na</span>(lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(SPECIMEN_COLLECTION_DATE, <span class="at">orders =</span> <span class="fu">c</span>(<span class="st">"mdY"</span>, <span class="st">"ymd"</span>, <span class="st">"Ymd"</span>))) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span> </span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sum =</span> <span class="fu">sum</span>(</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c_across</span>(QA_SA_INT_DUPE<span class="sc">:</span>QA_COLLECT_DATE_NA),</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="co"># print a table with sums of each error column for visibility</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>quality_check <span class="ot">&lt;-</span> fuzzy_pre_match_quality <span class="sc">%&gt;%</span> </span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(QA_SA_INT_DUPE<span class="sc">:</span>QA_COLLECT_DATE_NA) <span class="sc">%&gt;%</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colSums</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>quality_check</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="print-pre-match-errors" class="level2">
<h2 class="anchored" data-anchor-id="print-pre-match-errors">Print Pre-Match Errors</h2>
<p>At this point, we will filter and print all records that generated a positive result for any of the error checks in the previous section. At this point, we will have captured the following errors in the data:</p>
<ul>
<li>GISAID_ID (sequence accession) doesn’t show up more than once</li>
<li>GISAID_ID (sequence accession) isn’t already in WDRS</li>
<li>lineage is not NA or None and is in expected list</li>
<li>sequence status is COMPLETE, FAILED, or LOW QUALITY (not missing or other than one of these)</li>
<li>GISAID_ID (sequence accession) exists or doesn’t exist according to the logic for sequence statuses: if COMPLETE, GISAID_ID is present. If LOW_QUALITY, GISAID_ID may or may not be present. If FAILED, GISAID_ID is not present. Code also applies this check to statuses “HIGH CT” and “NOT DONE”, although either of these statuses will also be caught as an error because the only status permitted for invalid sequence results should be ’FAILED”.
<ul>
<li>error when status is complete but sa is missing</li>
<li>error when status is not complete and sa is not missing</li>
</ul></li>
<li>sequence reason is valid for the submitting lab</li>
<li>lineage exists or does not exist according to the logic for sequence statuses</li>
<li>patient name is not missing</li>
<li>DOB is not missing and is in a correct date format, and is NOT 1899-12-31, which may result when an excel date of 00000 is converted to yyyy-mm-dd</li>
<li>specimen collection date is not missing and is in the correct format</li>
</ul>
<p>fuzz_good_rows is the dataframe used to create rosters. We create it by filtering out all rows that generated an error, leaving behind only clean data.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [14]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print a file containing rows with errors</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>fuzz_bad_rows <span class="ot">&lt;-</span> fuzzy_pre_match_quality <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sum <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(fuzz_bad_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(fuzz_bad_rows <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>sum, <span class="sc">-</span>rowid), <span class="fu">file.path</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"For_Review/to_process_fuzzy_match"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"fuzzy_pre_match_quality_filter_"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">today</span>(),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">".csv"</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">na =</span> <span class="st">""</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  rows_printed <span class="ot">&lt;-</span> rows_printed <span class="sc">%&gt;%</span> <span class="fu">append</span>(fuzz_bad_rows<span class="sc">$</span>rowid)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="fu">length</span>(rows_printed), <span class="st">"of"</span>, <span class="fu">nrow</span>(fuzz), <span class="st">"rows have been printed"</span>))</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># split out the good data and pass it through to the rest of the script</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>fuzz_good_rows <span class="ot">&lt;-</span> fuzzy_pre_match_quality <span class="sc">%&gt;%</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sum <span class="sc">==</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="clean-data-sent-to-rosters" class="level2">
<h2 class="anchored" data-anchor-id="clean-data-sent-to-rosters">Clean Data Sent to Rosters</h2>
<p>fuzz_good_rows receives two final transformations before it is matched to WDRS data.</p>
<p>The custom <code>annihilate()</code> function is applied to FIRST_NAME and LAST_NAME from submitter data to produce names in a standardized format (example: JANE_DOE). See the Important Functions Wiki page for details about custom functions.</p>
<p>The DOB and SEQUENCE_SPECIMEN_COLLECTION_DATE columns are transformed to a uniform yyyy-mm-dd format.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [15]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fuzzy_match_initial <span class="ot">&lt;-</span> fuzz_good_rows <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">FNAME =</span> <span class="fu">annihilate</span>(FIRST_NAME),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">LNAME =</span> <span class="fu">annihilate</span>(LAST_NAME),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">DOB_SUBMITTER =</span> lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(DOB, <span class="at">orders =</span> <span class="fu">c</span>(<span class="st">"mdY"</span>, <span class="st">"ymd"</span>, <span class="st">"Ymd"</span>)),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">SEQUENCE_SPECIMEN_COLLECTION_DATE =</span> lubridate<span class="sc">::</span><span class="fu">parse_date_time</span>(SPECIMEN_COLLECTION_DATE, <span class="at">orders =</span> <span class="fu">c</span>(<span class="st">"mdY"</span>, <span class="st">"ymd"</span>, <span class="st">"Ymd"</span>))</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unite</span>(NAME_SUBMITTER,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(FNAME, LNAME),</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">remove =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    rowid,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    NAME_SUBMITTER,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    GISAID_ID,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_SPECIMEN_COLLECTION_DATE,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    DOB_SUBMITTER,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    PANGO_LINEAGE,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_REASON,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_STATUS,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    SUBMITTING_LAB,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    LAB_ACCESSION_ID</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="fuzzy-matching" class="level1">
<h1>Fuzzy matching</h1>
<p>Inexact matching between WDRS and submitter data relies on patient first and last name and date of birth. Additional matching based on specimen collection date is carried out after the initial matches based on demographics are identified.</p>
<p>First, records are grouped by the year of the date of birth of the patient, extracted from the DOB_SUBMITTER column for submitter data and the DOB_WDRS column for WDRS data to be matched.</p>
<p>An alternative name column is created for the submitter data, consisting of name data flipped so that the order of the names is last_first. Sometimes the name order in either submitter or wdrs data is flipped and so we match on both name orders to capture these instances.</p>
<p>Submitter data is split into a list of dataframes, each list containing records of patients grouped by the year of their birth.</p>
<p>The custom <code>fuzzy_match_name_flip()</code> function is applied to this list of submitter records. This function first blocks the data based on the birth year of the patient, splitting out WDRS records where the birth year of the patient matches the birth year of the submitter records to be matched. Then the function applies <code>stringdist_left_join()</code>, which matches names using <a href="https://en.wikipedia.org/wiki/Damerau%E2%80%93Levenshtein_distance">optimal string alignment</a> to look for near matches. The output includes a distance column with data on the distance between the submitter and WDRS names for matched records. A maximum distance of 3 characters is allowed here.</p>
<p>Additional matching columns are provided to allow filtering on matching date of birth and matching specimen collection date. Because we have noticed date of birth errors and unreliable specimen collection date data, we generate files for manual review that contain rows unable to be matched perfectly to WDRS using name and date of birth.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [16]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Block input on DOB year to reduce possible matches, and improve speed</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Break input into groups of records with the same DOB year</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># and use parallelization to run fuzzy matching across each of these groups</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>wdrs_entire<span class="sc">$</span>year <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">year</span>(wdrs_entire<span class="sc">$</span>DOB_WDRS)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>fuzzy_match_initial<span class="sc">$</span>year <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">year</span>(fuzzy_match_initial<span class="sc">$</span>DOB_SUBMITTER)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create groups based on DOB year</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>fuzzy_match_initial <span class="ot">&lt;-</span> fuzzy_match_initial <span class="sc">%&gt;%</span>                                        </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">group_num =</span> <span class="fu">cur_group_id</span>())</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add second version of the name with first and last name switched to account</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co"># for switching of fields</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>fuzzy_match_initial<span class="sc">$</span>NAME_SUBMITTER_2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">str_replace</span>(fuzzy_match_initial<span class="sc">$</span>NAME_SUBMITTER, <span class="st">".*_"</span>, <span class="st">""</span>),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">"_"</span>, <span class="fu">str_replace</span>(fuzzy_match_initial<span class="sc">$</span>NAME_SUBMITTER, <span class="st">"_.*"</span>, <span class="st">""</span>))</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># split input records into separate tables per group</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>fuzzy_split <span class="ot">&lt;-</span> <span class="fu">split</span>(fuzzy_match_initial, <span class="at">f =</span> fuzzy_match_initial<span class="sc">$</span>group_num)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co"># print size of each group</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(fuzzy_split, dim)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># apply the fuzzy matching function in parallel across 7 of 8 cores. Can use all cores if not performing other tasks. </span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>numCores  <span class="ot">=</span> <span class="fu">round</span>(parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">*</span> .<span class="dv">85</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makePSOCKcluster</span>(numCores)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co"># export the necessary elements of the local environment to all the cores</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">clusterExport</span>(</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">cl =</span> cl,</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">varlist =</span> <span class="fu">c</span>(<span class="st">"fuzzy_split"</span>, <span class="st">"wdrs_entire"</span>),</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">envir =</span> .GlobalEnv</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Run fuzzy matching</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  fuzzy_matches_wdrs <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(cl, fuzzy_split, fuzzymatch_name_flip) <span class="sc">%&gt;%</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="transformations-and-post-matching-quality-filters" class="level1 tabset">
<h1 class="tabset">Transformations and Post-matching Quality Filters</h1>
<p>Now that the submitter records have been assigned possible matches from WDRS, we apply final transformations and split out matches that contain errors.</p>
<section id="modify-date-types" class="level2">
<h2 class="anchored" data-anchor-id="modify-date-types">modify date types</h2>
<p>All date types are converted to the roster date format mm/dd/yyyy</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [17]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fuzzy_matches_wdrs <span class="ot">&lt;-</span> fuzzy_matches_wdrs <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">COLLECTION_DATE_WDRS =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(COLLECTION_DATE_WDRS), <span class="st">"%m/%d/%Y"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_SPECIMEN_COLLECTION_DATE =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(SEQUENCE_SPECIMEN_COLLECTION_DATE), <span class="st">"%m/%d/%Y"</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DOB_SUBMITTER =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(DOB_SUBMITTER), <span class="st">"%m/%d/%Y"</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">DOB_WDRS =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(DOB_WDRS), <span class="st">"%m/%d/%Y"</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  )))</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>fuzzy_match_initial <span class="ot">&lt;-</span> fuzzy_match_initial <span class="sc">%&gt;%</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">SEQUENCE_SPECIMEN_COLLECTION_DATE =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(SEQUENCE_SPECIMEN_COLLECTION_DATE), <span class="st">"%m/%d/%Y"</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  ))) <span class="sc">%&gt;%</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DOB_SUBMITTER =</span> <span class="fu">as.character</span>(<span class="fu">format</span>(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.Date</span>(DOB_SUBMITTER), <span class="st">"%m/%d/%Y"</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  )))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="filter-data-on-matching-dob" class="level2">
<h2 class="anchored" data-anchor-id="filter-data-on-matching-dob">Filter data on matching DOB</h2>
<p>Only possible matches with a perfectly matched date of birth are accepted. We discard matches generated by the fuzzy matching function where the name was a match but the date of birth is different.</p>
<p>This filter is easy to apply now; date formats require no modification because they have already been cleaned.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [18]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter out rows that have a dob that doesn't match any matching demographic rows in WDRS</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>fuzzy_dob_match <span class="ot">&lt;-</span> fuzzy_matches_wdrs <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DOB_MATCH =</span> <span class="fu">case_when</span>(DOB_SUBMITTER <span class="sc">==</span> DOB_WDRS <span class="sc">~</span> <span class="st">"match"</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>fuzzy_dob_filtered <span class="ot">&lt;-</span> fuzzy_dob_match <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DOB_MATCH <span class="sc">==</span> <span class="st">'match'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="no-case_id-assigned" class="level2">
<h2 class="anchored" data-anchor-id="no-case_id-assigned">No CASE_ID assigned</h2>
<p>Some submitter records might not have been assigned any matches from WDRS. Here, we split out these records as well as records for which only “bad” (non-matched date of birth) matches were assigned to the object did_not_match and printed to the Fuzzy_Matches/ subdirectory using the <code>print_rosters()</code> function, after being transformed to roster format.</p>
<p>the <code>roster_filters()</code> function is not applied here, as the error checks it performs are redundant with checks performed earlier in this script. In order to facilitate the use of the <code>print_rosters()</code> function, a dummy “sum” column is supplied, populated with 0’s.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [19]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this code chunk uses the roster_filters() function, but it modifies the output heavily so that a file is printed that combines dob-missing or error rows and does not include errors that do not pertain to fuzzy matching or to this particular file. </span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print for review</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>did_not_match <span class="ot">&lt;-</span> fuzzy_dob_match <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(CASE_ID) <span class="sc">|</span> <span class="fu">is.na</span>(DOB_MATCH),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span>(rowid <span class="sc">%in%</span> fuzzy_dob_filtered<span class="sc">$</span>rowid))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>did_not_match <span class="ot">&lt;-</span> did_not_match <span class="sc">%&gt;%</span>  <span class="fu">mutate</span>(</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">CASE_ID =</span> <span class="st">""</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_REASON =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>      (SUBMITTING_LAB <span class="sc">%in%</span> lab_vars<span class="sc">$</span>cdc_labs <span class="sc">&amp;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>output_seq_reasons_cdc) <span class="sc">~</span> SEQUENCE_REASON,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>      (<span class="sc">!</span>(SUBMITTING_LAB <span class="sc">%in%</span> <span class="fu">c</span>(lab_vars<span class="sc">$</span>cdc_labs, <span class="st">"PHL"</span>)) <span class="sc">&amp;</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>output_seq_reasons_non_cdc) <span class="sc">~</span> SEQUENCE_REASON,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>      (SUBMITTING_LAB <span class="sc">==</span> <span class="st">"PHL"</span> <span class="sc">&amp;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>output_seq_reasons_phl) <span class="sc">~</span> SEQUENCE_REASON,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>      (SUBMITTING_LAB <span class="sc">%in%</span> <span class="fu">c</span>(lab_vars<span class="sc">$</span>cdc_labs, <span class="st">"PHL"</span>) <span class="sc">&amp;</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>seq_reason_sent_surveillance) <span class="sc">~</span> <span class="st">"SENTINEL SURVEILLANCE"</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>      (SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>seq_reason_outbreak) <span class="sc">~</span> <span class="st">"OUTBREAK"</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_LAB =</span> SUBMITTING_LAB,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_SGTF =</span> <span class="st">""</span>,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_SPECIMEN =</span> <span class="st">"YES"</span>,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_DATE =</span> <span class="st">""</span>,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_REPOSITORY =</span> <span class="st">"GISAID"</span>,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_ACCESSION =</span> <span class="fu">case_when</span>(SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"FAILED"</span> <span class="sc">~</span> <span class="st">""</span>,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                                   SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"COMPLETE"</span> <span class="sc">~</span> GISAID_ID),</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_CLINICAL_ACCESSION =</span> <span class="fu">as.character</span>(LAB_ACCESSION_ID),</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">COLLECTION_DATE_WDRS =</span> <span class="st">""</span>,</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_REVIEWED =</span> <span class="st">""</span>,</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_EPI_ISL =</span> <span class="st">""</span>,</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_ROSTER_PREPARE_DATE =</span> <span class="fu">format</span>(<span class="fu">today</span>(), <span class="st">"%m/%d/%Y"</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_VARIANT =</span> <span class="fu">case_when</span>(PANGO_LINEAGE <span class="sc">%in%</span> voc <span class="sc">~</span> PANGO_LINEAGE,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>                                      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_NOTES =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(PANGO_LINEAGE) <span class="sc">~</span> <span class="fu">paste0</span>(</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Lineage identified as "</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>      PANGO_LINEAGE,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">" on "</span>,</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">today</span>(),</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">". Lineage assignments may change over time."</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(PANGO_LINEAGE) <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Case.Note =</span> <span class="st">"Case created and sequence data added through manual process."</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAME_SUBMISSION =</span> NAME_SUBMITTER,</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">DISTANCE_NAME =</span> <span class="st">""</span>,</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">NAME_WDRS =</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_VARIANT_OPEN_TEXT =</span> PANGO_LINEAGE) <span class="sc">%&gt;%</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sum =</span> <span class="st">"0"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    CASE_ID,</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_SGTF,</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_SPECIMEN,</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_DATE,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_REASON,</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_LAB,</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_STATUS,</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_REPOSITORY,</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_ACCESSION,</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_EPI_ISL,</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_VARIANT_OPEN_TEXT,</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_CLINICAL_ACCESSION,</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_SPECIMEN_COLLECTION_DATE,</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_ROSTER_PREPARE_DATE,</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_NOTES,</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_REVIEWED,</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    Case.Note,</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    NAME_SUBMITTER,</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">DOB =</span> DOB_SUBMITTER,</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    DISTANCE_NAME,</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    NAME_WDRS,</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    COLLECTION_DATE_WDRS,</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>    rowid</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sum =</span> <span class="dv">0</span>)</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>fuzzy_match_successful <span class="ot">&lt;-</span> <span class="fu">filter</span>(fuzzy_dob_filtered, <span class="sc">!</span>rowid <span class="sc">%in%</span> did_not_match<span class="sc">$</span>rowid) <span class="sc">%&gt;%</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year.x, <span class="sc">-</span>year.y, <span class="sc">-</span>group_num)</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a><span class="fu">print_roster</span>(did_not_match, <span class="at">for_review =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>fuzzy_match_successful_clean <span class="ot">&lt;-</span> fuzzy_match_successful <span class="sc">%&gt;%</span></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="sc">!</span><span class="fu">duplicated</span>(fuzzy_match_successful <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>NAME_WDRS)))</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>rows_printed <span class="ot">&lt;-</span> rows_printed <span class="sc">%&gt;%</span> <span class="fu">append</span>(did_not_match<span class="sc">$</span>rowid)</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="fu">length</span>(rows_printed), <span class="st">"of"</span>, <span class="fu">nrow</span>(fuzz), <span class="st">"rows have been printed"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="fuzzy-roster-transformations" class="level2">
<h2 class="anchored" data-anchor-id="fuzzy-roster-transformations">Fuzzy Roster Transformations</h2>
<p>Here, fuzzy match data is transformed to the schema that Data Support has agreed to review, and columns that belong in the roster are selected.</p>
<p>The lab_vars object contains a list of sequence reasons that are used here to assign sequence reasons matched to three different submitter categories. In order to understand these, inspect the lab_vars list pulled into the environment at the beginning of the script.</p>
<p>Another object used here that is imported from outside this script is the voc list of variants of concern. Visit the Lineages section of Import Data at the beginning of this script for details.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [20]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fuzzy_match_transform <span class="ot">&lt;-</span> fuzzy_match_successful <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_REASON =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>      (SUBMITTING_LAB <span class="sc">%in%</span> lab_vars<span class="sc">$</span>cdc_labs <span class="sc">&amp;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>output_seq_reasons_cdc) <span class="sc">~</span> SEQUENCE_REASON,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      (<span class="sc">!</span>(SUBMITTING_LAB <span class="sc">%in%</span> <span class="fu">c</span>(lab_vars<span class="sc">$</span>cdc_labs, <span class="st">"PHL"</span>)) <span class="sc">&amp;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>output_seq_reasons_non_cdc) <span class="sc">~</span> SEQUENCE_REASON,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>      (SUBMITTING_LAB <span class="sc">==</span> <span class="st">"PHL"</span> <span class="sc">&amp;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>output_seq_reasons_phl) <span class="sc">~</span> SEQUENCE_REASON,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      (SUBMITTING_LAB <span class="sc">%in%</span> <span class="fu">c</span>(lab_vars<span class="sc">$</span>cdc_labs, <span class="st">"PHL"</span>) <span class="sc">&amp;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>seq_reason_sent_surveillance) <span class="sc">~</span> <span class="st">"SENTINEL SURVEILLANCE"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>      (SEQUENCE_REASON <span class="sc">%in%</span> lab_vars<span class="sc">$</span>seq_reason_outbreak) <span class="sc">~</span> <span class="st">"OUTBREAK"</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_LAB =</span> SUBMITTING_LAB,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_SGTF =</span> <span class="st">""</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_SPECIMEN =</span> <span class="st">"YES"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_DATE =</span> <span class="st">""</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_REPOSITORY =</span> <span class="st">"GISAID"</span>,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_ACCESSION =</span> <span class="fu">case_when</span>(SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"FAILED"</span> <span class="sc">~</span> <span class="st">""</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                                   SEQUENCE_STATUS <span class="sc">==</span> <span class="st">"COMPLETE"</span> <span class="sc">~</span> GISAID_ID),</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_CLINICAL_ACCESSION =</span> <span class="fu">as.character</span>(SpecimenId),</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_REVIEWED =</span> <span class="st">""</span>,</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_EPI_ISL =</span> <span class="st">""</span>,</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">SEQUENCE_ROSTER_PREPARE_DATE =</span> <span class="fu">format</span>(<span class="fu">today</span>(), <span class="st">"%m/%d/%Y"</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_VARIANT =</span> <span class="fu">case_when</span>(PANGO_LINEAGE <span class="sc">%in%</span> voc <span class="sc">~</span> PANGO_LINEAGE,</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                                      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_NOTES =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(PANGO_LINEAGE) <span class="sc">~</span> <span class="fu">paste0</span>(</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Lineage identified as "</span>,</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>      PANGO_LINEAGE,</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">" on "</span>,</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">today</span>(),</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">". Lineage assignments may change over time."</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.na</span>(PANGO_LINEAGE) <span class="sc">~</span> <span class="st">""</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Case.Note =</span> <span class="st">"External data question package updated by COVID19 Sequencing Roster."</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NAME_SUBMISSION =</span> NAME_SUBMITTER) <span class="sc">%&gt;%</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_VARIANT_OPEN_TEXT =</span> PANGO_LINEAGE) <span class="sc">%&gt;%</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    rowid,</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    CASE_ID,</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_SGTF,</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_SPECIMEN,</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_DATE,</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_REASON,</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_LAB,</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_STATUS,</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_REPOSITORY,</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_ACCESSION,</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_EPI_ISL,</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_VARIANT_OPEN_TEXT,</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_CLINICAL_ACCESSION,</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_SPECIMEN_COLLECTION_DATE,</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_ROSTER_PREPARE_DATE,</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_NOTES,</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    SEQUENCE_REVIEWED,</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    Case.Note,</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    COLLECTION_DATE_WDRS,</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    NAME_SUBMITTER,</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">DOB =</span> DOB_SUBMITTER,</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">DISTANCE_NAME =</span> distance,</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    NAME_WDRS</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="collection-date-filter" class="level2 tabset">
<h2 class="tabset anchored" data-anchor-id="collection-date-filter">Collection Date Filter</h2>
<section id="filter-data-on-14-day-window" class="level3">
<h3 class="anchored" data-anchor-id="filter-data-on-14-day-window">Filter Data on 14 Day Window</h3>
<p>Now that collection dates are formatted, the interval in days is calculated between WDRS and submitter sequencing data. Rows with collection dates outside 14 days are filtered and sent to a for review folder. For most of these, there will be another possible match where the collection date was within the acceptable window. We address records where there is only a mismatched collection date in the next section.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [21]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fuzzy_match_transform <span class="ot">&lt;-</span> fuzzy_match_transform <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the interval in days between collection dates in submitter and wdrs data</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">int =</span> <span class="fu">interval</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mdy</span>(SEQUENCE_SPECIMEN_COLLECTION_DATE),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mdy</span>(COLLECTION_DATE_WDRS)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">COLLECTION_DATE_DISTANCE =</span> <span class="fu">time_length</span>(int, <span class="at">unit =</span> <span class="st">"day"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(int)) <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># remove rows where the distance is greater than 14 days</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>fuzzy_colldate_filtered <span class="ot">&lt;-</span> fuzzy_match_transform  <span class="sc">%&gt;%</span> </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(COLLECTION_DATE_DISTANCE) <span class="sc">&amp;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>           <span class="fu">abs</span>(COLLECTION_DATE_DISTANCE) <span class="sc">&lt;=</span> <span class="dv">14</span> <span class="sc">&amp;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>           <span class="sc">!</span><span class="fu">is.na</span>(SEQUENCE_SPECIMEN_COLLECTION_DATE))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="collection-date-mismatch" class="level3">
<h3 class="anchored" data-anchor-id="collection-date-mismatch">Collection Date Mismatch</h3>
<p>Some matched records with a collection date difference outside 14 days are the only available match for a sequencing result. We split these out for manual review so that they are not lost, and add them back to the data for filtering and rostering.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [22]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get records where the specimen collection date and wdrs collection date</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fell outside the 14 day window, and which are not recorded elsewhere</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>fuzzy_colldate_mismatch <span class="ot">&lt;-</span> fuzzy_match_transform <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(<span class="sc">!</span>rowid <span class="sc">%in%</span> fuzzy_colldate_filtered<span class="sc">$</span>rowid) <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># add records with collection date mismatch and no other match back into the table of matches</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>fuzzy_colldate_evaluated <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fuzzy_colldate_filtered, fuzzy_colldate_mismatch) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">QA_COLLECT_DATE =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(COLLECTION_DATE_DISTANCE) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">abs</span>(COLLECTION_DATE_DISTANCE) <span class="sc">&gt;</span> <span class="dv">14</span> <span class="sc">~</span> <span class="dv">1</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<p>If there are two possible matches with the same collection date and same case ID but different sequence clinical accessions, match to patient level (get rid of sequence clinical accession)</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [23]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fuzzy_sca_count <span class="ot">&lt;-</span> fuzzy_colldate_evaluated <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(CASE_ID, SEQUENCE_ACCESSION) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n_distinct</span>(SEQUENCE_CLINICAL_ACCESSION) )</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># join the counts back to the rest of the data</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>join_counts <span class="ot">&lt;-</span> <span class="fu">left_join</span>(fuzzy_colldate_evaluated, fuzzy_sca_count, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"CASE_ID"</span>, <span class="st">"SEQUENCE_ACCESSION"</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(COLLECTION_DATE_DISTANCE) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>COLLECTION_DATE_DISTANCE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="case-counts" class="level2">
<h2 class="anchored" data-anchor-id="case-counts">Case Counts</h2>
<p>In cases where there are multiple sequence clinical accessions from WDRS are tied to a single unique case id + sequence accession combination, implying that the algorithm cannot distinguish between the sequence clinical accession is dropped and the record is matched to the patient level only.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [24]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if there is &gt;1 SCA per unique case_id + SA, remove all SCA from that case_id </span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fuzzy_cleaned <span class="ot">&lt;-</span> join_counts <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SEQUENCE_CLINICAL_ACCESSION =</span> <span class="fu">if_else</span>(count <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="st">""</span>, SEQUENCE_CLINICAL_ACCESSION))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># deduplicate the records so that they are matched to only the patient level, but keep the WDRS collection date for error checking</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>fuzzy_cleaned <span class="ot">&lt;-</span> fuzzy_cleaned[<span class="sc">!</span><span class="fu">duplicated</span>(fuzzy_cleaned <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>COLLECTION_DATE_WDRS)),]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>fuzzy_case_counts <span class="ot">&lt;-</span>  fuzzy_cleaned <span class="sc">%&gt;%</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="sc">!</span><span class="fu">duplicated</span>(fuzzy_cleaned <span class="sc">%&gt;%</span> <span class="fu">select</span>(rowid<span class="sc">:</span>Case.Note))) <span class="sc">%&gt;%</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>count)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="print-rosters" class="level1 tabset">
<h1 class="tabset">Print Rosters</h1>
<p>Rosters are split out from fuzzy_case_counts based on match quality.</p>
<section id="perfect-matches" class="level2">
<h2 class="anchored" data-anchor-id="perfect-matches">Perfect Matches</h2>
<p>Some of the rows that have been matched to case id’s using demographics are ready to be sent to WDRS along with the rest of the roster. These are specimens where there is a perfect match between PHL and WDRS data for name, date of birth, and collection date of less than 14 days distance.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [25]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#perfect matches: send to write_roster_here</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>fuzzy_matched_perfect <span class="ot">&lt;-</span> fuzzy_case_counts <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only perfect name matches</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DISTANCE_NAME <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">QA_MULTIPLE_MATCH =</span> <span class="fu">case_when</span>(rowid <span class="sc">%in%</span> rowid[<span class="fu">duplicated</span>(rowid)] <span class="sc">~</span> <span class="dv">1</span>))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># apply roster filters</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>fuzzy_perfect <span class="ot">&lt;-</span>fuzzy_matched_perfect <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sum =</span> <span class="fu">sum</span>(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c_across</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH),</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fuzzy_perfect <span class="sc">%&gt;%</span> </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH) <span class="sc">%&gt;%</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colSums</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># use the custom print_roster function; this will be modified to also print a roster of data with errors</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Fuzzy perfects are sent to "write_roster_here" and will go through Roster Compile script</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Fuzzy perfects with errors are sent to For_Review</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print_roster</span>(fuzzy_perfect, <span class="at">for_review =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print_error_rows</span>(fuzzy_perfect, <span class="at">roster_now =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>rows_printed <span class="ot">&lt;-</span> rows_printed <span class="sc">%&gt;%</span> <span class="fu">append</span>(<span class="fu">unique</span>(fuzzy_perfect<span class="sc">$</span>rowid))</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="fu">length</span>(rows_printed), <span class="st">"of"</span>, <span class="fu">nrow</span>(fuzz), <span class="st">"rows have been printed"</span>))</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co"># remove matched records from table</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>fuzzy_case_counts <span class="ot">&lt;-</span> <span class="fu">filter</span>(fuzzy_case_counts, <span class="sc">!</span>rowid <span class="sc">%in%</span> fuzzy_perfect<span class="sc">$</span>rowid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="fuzzy1" class="level2">
<h2 class="anchored" data-anchor-id="fuzzy1">Fuzzy1</h2>
<p>Roster now: records with a name distance of 1 and a matching date of birth AND specimen collection date within the 14 day window.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [26]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fuzzy 1 rows are rows where the best match was a name distance of 1</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>fuzzy1 <span class="ot">&lt;-</span> fuzzy_case_counts <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DISTANCE_NAME <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is just for the convenience of anyone manually reviewing an output file to check matches</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(SEQUENCE_ACCESSION) <span class="sc">%&gt;%</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">QA_MULTIPLE_MATCH =</span> <span class="fu">case_when</span>(rowid <span class="sc">%in%</span> rowid[<span class="fu">duplicated</span>(rowid)] <span class="sc">~</span> <span class="dv">1</span>))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>fuzzy1_roster_now <span class="ot">&lt;-</span> fuzzy1 <span class="sc">%&gt;%</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sum =</span> <span class="fu">sum</span>(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c_across</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH),</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fuzzy1 <span class="sc">%&gt;%</span> </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH) <span class="sc">%&gt;%</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colSums</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Fuzzy1 records are sent to "write_roster_here" and will go through Roster Compile script</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Fuzzy1 records with errors are sent to For_Review</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print_roster</span>(fuzzy1_roster_now, <span class="at">for_review =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print_error_rows</span>(fuzzy1_roster_now, <span class="at">roster_now =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>rows_printed <span class="ot">&lt;-</span> rows_printed <span class="sc">%&gt;%</span> <span class="fu">append</span>(<span class="fu">unique</span>(fuzzy1_roster_now<span class="sc">$</span>rowid))</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="fu">length</span>(rows_printed), <span class="st">"of"</span>, <span class="fu">nrow</span>(fuzz), <span class="st">"rows have been printed"</span>))</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="co"># remove matched records from table</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>fuzzy_case_counts <span class="ot">&lt;-</span> <span class="fu">filter</span>(fuzzy_case_counts, <span class="sc">!</span>rowid <span class="sc">%in%</span> fuzzy1_roster_now<span class="sc">$</span>rowid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="fuzzy2" class="level2">
<h2 class="anchored" data-anchor-id="fuzzy2">Fuzzy2</h2>
<p>Records with a name distance of 2 will be sent to the fuzzy matches folder for manual review.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [27]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fuzzy2 <span class="ot">&lt;-</span> fuzzy_case_counts <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DISTANCE_NAME <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">SEQUENCE_CLINICAL_ACCESSION =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(SEQUENCE_SPECIMEN_COLLECTION_DATE) <span class="sc">~</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">SEQUENCE_ROSTER_PREPARE_DATE =</span> <span class="fu">format</span>(<span class="fu">today</span>(), <span class="st">"%m/%d/%Y"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">SEQUENCE_EPI_ISL =</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(SEQUENCE_ACCESSION) <span class="sc">%&gt;%</span> </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">QA_MULTIPLE_MATCH =</span> <span class="fu">case_when</span>(rowid <span class="sc">%in%</span> rowid[<span class="fu">duplicated</span>(rowid)] <span class="sc">~</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sum =</span> <span class="fu">sum</span>(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c_across</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fuzzy2 <span class="sc">%&gt;%</span> </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH) <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colSums</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print_roster</span>(fuzzy2, <span class="at">for_review =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print_error_rows</span>(fuzzy2)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>rows_printed <span class="ot">&lt;-</span> rows_printed <span class="sc">%&gt;%</span> <span class="fu">append</span>(<span class="fu">unique</span>(fuzzy2<span class="sc">$</span>rowid))</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="fu">length</span>(rows_printed), <span class="st">"of"</span>, <span class="fu">nrow</span>(fuzz), <span class="st">"rows have been printed"</span>))</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="co"># remove matched records from table</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>fuzzy_case_counts <span class="ot">&lt;-</span> <span class="fu">filter</span>(fuzzy_case_counts, <span class="sc">!</span>rowid <span class="sc">%in%</span> fuzzy2<span class="sc">$</span>rowid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="fuzzy3" class="level2">
<h2 class="anchored" data-anchor-id="fuzzy3">Fuzzy3</h2>
<p>Records with a name distance of 3 will be sent to the fuzzy matches folder for manual review.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [28]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fuzzy3 <span class="ot">&lt;-</span> fuzzy_case_counts <span class="sc">%&gt;%</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(DISTANCE_NAME <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">SEQUENCE_CLINICAL_ACCESSION =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(SEQUENCE_SPECIMEN_COLLECTION_DATE) <span class="sc">~</span> <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">SEQUENCE_ROSTER_PREPARE_DATE =</span> <span class="fu">format</span>(<span class="fu">today</span>(), <span class="st">"%m/%d/%Y"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">SEQUENCE_EPI_ISL =</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(SEQUENCE_ACCESSION) <span class="sc">%&gt;%</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">QA_MULTIPLE_MATCH =</span> <span class="fu">case_when</span>(rowid <span class="sc">%in%</span> rowid[<span class="fu">duplicated</span>(rowid)] <span class="sc">~</span> <span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sum =</span> <span class="fu">sum</span>(</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c_across</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH),</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fuzzy3 <span class="sc">%&gt;%</span> </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(QA_COLLECT_DATE<span class="sc">:</span>QA_MULTIPLE_MATCH) <span class="sc">%&gt;%</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colSums</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print_roster</span>(fuzzy3, <span class="at">for_review =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print_error_rows</span>(fuzzy3)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>rows_printed <span class="ot">&lt;-</span> rows_printed <span class="sc">%&gt;%</span> <span class="fu">append</span>(<span class="fu">unique</span>(fuzzy3<span class="sc">$</span>rowid))</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="fu">length</span>(rows_printed), <span class="st">"of"</span>, <span class="fu">nrow</span>(fuzz), <span class="st">"rows have been printed"</span>))</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co"># remove matched records from table</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>fuzzy_case_counts <span class="ot">&lt;-</span> <span class="fu">filter</span>(fuzzy_case_counts, <span class="sc">!</span>rowid <span class="sc">%in%</span> fuzzy3<span class="sc">$</span>rowid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="wrap-up" class="level1 tabset">
<h1 class="tabset">Wrap-UP</h1>
<section id="saved-rows" class="level2">
<h2 class="anchored" data-anchor-id="saved-rows">Saved Rows</h2>
<p>Any records with rowid’s not printed to other files are sent to the rows_not_yet_printed subfolder of the Fuzzy Matches submissions folder in the saved_rows file.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [29]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>old_saved_delete <span class="ot">&lt;-</span> <span class="fu">dir_ls</span>(<span class="st">"Submissions/Fuzzy_Match/rows_not_yet_printed"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">file_delete</span>(old_saved_delete)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>fuzz_saved <span class="ot">&lt;-</span> fuzz <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>(rowid <span class="sc">%in%</span> rows_printed))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(fuzz_saved, <span class="fu">paste0</span>(<span class="st">"Submissions//Fuzzy_Match//rows_not_yet_printed//saved_rows_"</span>, <span class="fu">today</span>(), <span class="st">".csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="move-files" class="level2">
<h2 class="anchored" data-anchor-id="move-files">Move Files</h2>
<p>Input files are moved to the Completed folder.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [30]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>files_to_move <span class="ot">&lt;-</span>  <span class="fu">dir_ls</span>(<span class="fu">paste0</span>(<span class="st">"Submissions/Fuzzy_Match"</span>), <span class="at">type =</span> <span class="st">"file"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>new_file_names <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Completed_Submissions/Fuzzy_Match/"</span>, <span class="fu">basename</span>(files_to_move))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">file_move</span>(files_to_move, new_file_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
<section id="completed-email" class="level2">
<h2 class="anchored" data-anchor-id="completed-email">Completed Email</h2>
<p>Alerts are compiled and an email is sent with details about the files produced by the script.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [31]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>all_fuzzy_files <span class="ot">&lt;-</span> <span class="fu">dir_ls</span>(<span class="st">"write_roster_here"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_subset</span>(<span class="st">"fuzzy"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>all_fuzzy_files <span class="ot">&lt;-</span> <span class="fu">c</span>(all_fuzzy_files, <span class="fu">dir_ls</span>(<span class="st">"For_Review"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_subset</span>(<span class="st">"fuzzy"</span>))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>all_fuzzy_files <span class="ot">&lt;-</span> <span class="fu">c</span>(all_fuzzy_files, <span class="fu">dir_ls</span>(<span class="st">"For_Review/to_process_fuzzy_match"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_subset</span>(<span class="st">"fuzzy"</span>))</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>all_fuzzy_files <span class="ot">&lt;-</span> <span class="fu">c</span>(all_fuzzy_files, <span class="fu">dir_ls</span>(<span class="st">"Fuzzy_matches"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_subset</span>(<span class="st">"fuzzy"</span>))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>all_fuzzy_files <span class="ot">&lt;-</span>  <span class="fu">c</span>(all_fuzzy_files, <span class="fu">dir_ls</span>(<span class="st">"Fuzzy_matches/Fuzzy_Error_Checks"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_subset</span>(<span class="st">"fuzzy"</span>))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>all_fuzzy_files <span class="ot">&lt;-</span>  <span class="fu">c</span>(all_fuzzy_files, <span class="fu">dir_ls</span>(<span class="st">"Fuzzy_matches"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_subset</span>(<span class="st">"did_not_match"</span>))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>today_fuzzy_files <span class="ot">&lt;-</span> all_fuzzy_files[<span class="fu">str_detect</span>(all_fuzzy_files, <span class="fu">as.character</span>(<span class="fu">today</span>()))] <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>today_fuzzy_review_files1 <span class="ot">&lt;-</span> today_fuzzy_files <span class="sc">%&gt;%</span> <span class="fu">str_extract</span>(<span class="st">"For_Review.*"</span>) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>today_fuzzy_review_files2 <span class="ot">&lt;-</span> today_fuzzy_files <span class="sc">%&gt;%</span> <span class="fu">str_extract</span>(<span class="st">"Fuzzy_matches.*"</span>) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>today_fuzzy_review_files <span class="ot">&lt;-</span> <span class="fu">c</span>(today_fuzzy_review_files1, today_fuzzy_review_files2)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>today_fuzzy_roster_files <span class="ot">&lt;-</span> today_fuzzy_files <span class="sc">%&gt;%</span> <span class="fu">str_extract</span>(<span class="st">"write_roster_here.*"</span>) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize message</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>fuzzy_email_message <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Fuzzy matched files were printed for COVID Sequencing data for"</span>, <span class="fu">format</span>(<span class="fu">today</span>(), <span class="st">"%m/%d/%Y"</span>), </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"and are ready for manual review. </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co"># if there files that are ready to be added to the roster</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(today_fuzzy_roster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  today_fuzzy_roster_file_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">unlist</span>(today_fuzzy_roster_files), <span class="at">collapse=</span><span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>  fuzzy_email_message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(fuzzy_email_message,<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span> , <span class="st">"There were a total of "</span>, <span class="fu">length</span>(today_fuzzy_roster_files), <span class="st">" file(s) written today that contain records that could be exactly matched to records in WDRS and are ready to be added to the roster. These files can be found at: "</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, today_fuzzy_roster_file_names)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="co"># if there files that are ready to be added to the roster</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(today_fuzzy_review_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    today_fuzzy_review_file_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">unlist</span>(today_fuzzy_review_files), <span class="at">collapse=</span><span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  fuzzy_email_message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(fuzzy_email_message,<span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span> , <span class="st">"There were a total of "</span>, <span class="fu">length</span>(today_fuzzy_review_files), <span class="st">" file(s) written today that require manual review. These files can be found at: "</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, today_fuzzy_review_file_names)</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize message</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>fuzzy_email_message <span class="ot">&lt;-</span> <span class="fu">paste0</span>(fuzzy_email_message, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="st">"Note: This is an automated message. Please enable your outlook to include extra line breaks to view this message in its proper format."</span>, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>, <span class="st">"This message is in development, and will be updated. If you see any errors reach out to DIQA. Thanks!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [32]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># send email notifying that fuzzy matching has completed</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  sendmailR<span class="sc">::</span><span class="fu">sendmail</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> <span class="st">""</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">to =</span> <span class="fu">c</span>(</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">""</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">subject =</span> <span class="st">"Sequencing - COVID Sequencing Fuzzy Match script complete"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">msg =</span> fuzzy_email_message,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">headers =</span> <span class="fu">list</span>(<span class="st">"Reply-To"</span> <span class="ot">=</span> <span class="st">""</span>),</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">smtpServer =</span> <span class="st">""</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
</section>
<section id="update-fuzzy-for-review-running-list" class="level1">
<h1>Update fuzzy for review running list</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [33]:</pre></div><div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in running file</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>running_list <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"For_Review/running_lists/fuzzy_for_review_records.csv"</span>, <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>) )</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in any fuzzy perfect/fuzzy1/fuzzy2/fuzzy3 error row files from today</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>fuzzy_review_files <span class="ot">&lt;-</span> <span class="fu">dir_ls</span>(<span class="st">"For_Review"</span>, <span class="at">type=</span><span class="st">"file"</span>) <span class="sc">%&gt;%</span> <span class="fu">str_subset</span>(<span class="st">"fuzzy"</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># only today</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>fuzzy_review_files <span class="ot">&lt;-</span> fuzzy_review_files[<span class="fu">str_detect</span>(fuzzy_review_files, <span class="fu">as.character</span>(<span class="fu">today</span>()))] <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty dataframe</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>fuzzy_other_review <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(fuzzy_review_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(fuzzy_review_files)){</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>temp_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fuzzy_review_files[i], <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>))</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>temp_data<span class="ot">&lt;-</span>temp_data <span class="sc">%&gt;%</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(<span class="at">File_PATH=</span>fuzzy_review_files[i])</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>fuzzy_other_review <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(fuzzy_other_review, temp_data)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>fuzz_bad_rows <span class="ot">&lt;-</span> fuzz_bad_rows <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.character))</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>did_not_match <span class="ot">&lt;-</span> did_not_match <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.character))</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all records</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>running_list_updated <span class="ot">&lt;-</span><span class="fu">bind_rows</span>(fuzzy_other_review, fuzz_bad_rows, did_not_match, running_list)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure sequence accession is filled out</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>running_list_updated <span class="ot">&lt;-</span> running_list_updated <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">SEQUENCE_ACCESSION =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(SEQUENCE_ACCESSION) <span class="sc">~</span> GISAID_ID, </span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>                                                                                      (<span class="sc">!</span>(<span class="fu">is.na</span>(SEQUENCE_ACCESSION)) <span class="sc">~</span>SEQUENCE_ACCESSION)))</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Flag records now in WDRS</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>running_list_updated <span class="ot">&lt;-</span> running_list_updated <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">WDRS_complete =</span> <span class="fu">ifelse</span>(SEQUENCE_ACCESSION <span class="sc">%in%</span> wdrs_sa_flat_values, <span class="st">"1"</span>, <span class="st">"0"</span>))<span class="sc">%&gt;%</span><span class="fu">distinct</span>(SEQUENCE_ACCESSION, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>wdrs_complete <span class="ot">&lt;-</span> running_list_updated <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WDRS_complete<span class="sc">==</span><span class="dv">1</span>)<span class="sc">%&gt;%</span><span class="fu">distinct</span>(SEQUENCE_ACCESSION)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>manual_review_total <span class="ot">&lt;-</span> running_list_updated <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WDRS_complete<span class="sc">==</span><span class="dv">0</span>)<span class="sc">%&gt;%</span><span class="fu">distinct</span>(SEQUENCE_ACCESSION)</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Write updated list</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(running_list_updated, <span class="fu">file.path</span>(<span class="fu">paste0</span>(<span class="st">"For_Review/running_lists/fuzzy_for_review_records.csv"</span>)), <span class="at">na=</span><span class="st">""</span>,<span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Send email with review results</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>  email_from <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>  email_to <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>  email_subj <span class="ot">&lt;-</span> <span class="st">"Sequencing - Fuzzy For Review Summary Automated Email"</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>  email_body <span class="ot">&lt;-</span> <span class="fu">paste</span>(</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Overview: </span><span class="sc">\n</span><span class="st"> </span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">nrow</span>(manual_review_total)), <span class="st">"records pending manual review or roster. </span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">nrow</span>(wdrs_complete)), <span class="st">"records completed to date.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="co"># send it</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>sendmailR<span class="sc">::</span><span class="fu">sendmail</span>(<span class="at">from =</span> email_from,</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>                    <span class="at">to =</span> email_to,</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>                    <span class="at">subject =</span> email_subj,</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>                    <span class="at">msg =</span> email_body,</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>                    <span class="at">headers=</span> <span class="fu">list</span>(<span class="st">"Reply-To"</span> <span class="ot">=</span> email_from),</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">smtpServer =</span> <span class="st">""</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>  </div> <!-- /content --> 
  
</body></html>